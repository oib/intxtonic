<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>inTXTonic â€¢ Admin</title>
  <style>
    /* Normalize heading sizes/margins for sectioned headings to silence browser warnings */
    h1 { font-size: 1.75rem; margin: 0 0 0.5rem 0; }
    h2 { font-size: 1.25rem; margin: 0 0 0.5rem 0; }
  </style>
  <link rel="preload" href="/src/frontend/css/base.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/src/frontend/css/base.css"></noscript>
  <link rel="preload" href="/src/frontend/css/components.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/src/frontend/css/components.css"></noscript>
  <link rel="preload" href="/src/frontend/css/layout.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/src/frontend/css/layout.css"></noscript>
  <script type="module" src="/src/frontend/js/i18n-runtime.js" data-i18n-init></script>
</head>
<body>
  <header class="site">
    <div class="inner container nav-3">
      <div class="left flex ai-c" style="gap:8px"></div>
      <nav class="flex ai-c" style="gap:8px">
        <a class="btn btn--subtle" href="/dashboard" data-i18n="nav.dashboard">Dashboard</a>
        <a id="login-link" class="btn btn--subtle" href="/login" data-i18n="nav.login">Login</a>
        <button id="logout-btn" class="btn btn--ghost" style="display:none" data-i18n="nav.logout">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="row">
      <div class="col-12">
        <div class="card">
          <h1 data-i18n="admin.panel">Admin Panel</h1>
          <p style="color:var(--tx-1)" data-i18n="admin.panel_hint">Manage moderation queues and tags. Restricted to admin and moderator roles.</p>
          <div class="flex ai-c" style="gap:8px; flex-wrap:wrap; margin-top:12px">
            <a id="i18n-link" class="btn btn--subtle" href="/admin/i18n" style="display:none" data-i18n="admin.i18n">Translations</a>
            <a id="moderation-link" class="btn btn--subtle" href="/admin/moderation" style="display:none">Moderation</a>
            <a id="user-access-link" class="btn btn--subtle" href="/admin/users" style="display:none">User access</a>
            <a id="tags-link" class="btn btn--subtle" href="/admin/tags" style="display:none">Tags</a>
            <a id="queue-link" class="btn btn--subtle" href="/admin/queue" style="display:none">AI Queue</a>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer class="site">
    <div class="inner container flex ai-c jc-b">
      <div> <span id="year"></span> inTXTonic</div>
      <div class="hide-sm">Built with Windsurf guidelines</div>
    </div>
  </footer>

  <script type="module">
    import { authHeaders, getToken, clearToken } from '/src/frontend/js/auth.js';
    import { showToast } from '/src/frontend/js/toast.js';
    import { t } from '/src/frontend/js/i18n-runtime.js';

    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear().toString();

    const loginLink = document.getElementById('login-link');
    const logoutBtn = document.getElementById('logout-btn');
    const adminLinks = {
      i18n: document.getElementById('i18n-link'),
      moderation: document.getElementById('moderation-link'),
      users: document.getElementById('user-access-link'),
      tags: document.getElementById('tags-link'),
      queue: document.getElementById('queue-link'),
    };

    let currentUser = null;
    let isStaff = false;

    async function loadCurrentUser() {
      try {
        const res = await fetch('/auth/me', { headers: { ...authHeaders() } });
        if (!res.ok) {
          window.location.href = '/login';
          return false;
        }
        currentUser = await res.json();
        const roles = Array.isArray(currentUser?.roles) ? currentUser.roles : [];
        isStaff = !!currentUser?.is_admin || roles.includes('moderator');
        if (!isStaff) {
          showToast(t('toast.access_denied'), 'err');
          window.location.href = '/';
          return false;
        }
        return true;
      } catch {
        window.location.href = '/login';
        return false;
      }
    }

    function refreshAuthUI() {
      const has = !!getToken();
      if (loginLink) loginLink.style.display = has ? 'none' : 'inline-flex';
      if (logoutBtn) logoutBtn.style.display = has ? 'inline-flex' : 'none';
    }

    function showAdminLinks() {
      if (!isStaff) return;
      if (adminLinks.i18n) adminLinks.i18n.style.display = 'inline-flex';
      if (adminLinks.moderation) adminLinks.moderation.style.display = 'inline-flex';
      if (adminLinks.users) adminLinks.users.style.display = 'inline-flex';
      if (adminLinks.tags) adminLinks.tags.style.display = 'inline-flex';
      if (adminLinks.queue) adminLinks.queue.style.display = 'inline-flex';
    }

    logoutBtn?.addEventListener('click', async () => {
      try {
        await fetch('/auth/logout', { method: 'POST', headers: { ...authHeaders() } });
      } catch {}
      clearToken();
      showToast(t('toast.signed_out'), 'ok');
      window.location.href = '/';
    });

    (async () => {
      const ok = await loadCurrentUser();
      if (!ok) return;
      refreshAuthUI();
      showAdminLinks();
    })();
  </script>
</body>
</html>
