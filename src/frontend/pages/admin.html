<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>inTXTonic • Admin</title>
  <style>
    /* Normalize heading sizes/margins for sectioned headings to silence browser warnings */
    h1 { font-size: 1.75rem; margin: 0 0 0.5rem 0; }
    h2 { font-size: 1.25rem; margin: 0 0 0.5rem 0; }
  </style>
  <link rel="preload" href="/src/frontend/css/base.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/src/frontend/css/base.css"></noscript>
  <link rel="preload" href="/src/frontend/css/components.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/src/frontend/css/components.css"></noscript>
  <link rel="preload" href="/src/frontend/css/layout.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/src/frontend/css/layout.css"></noscript>
  <script type="module" src="/src/frontend/js/i18n-runtime.js" data-i18n-init></script>
</head>
<body>
  <header class="site">
    <div class="inner container nav-3">
      <div class="left flex ai-c" style="gap:8px"></div>
      <nav class="flex ai-c" style="gap:8px">
        <a class="btn btn--subtle" href="/dashboard" data-i18n="nav.dashboard">Dashboard</a>
        <a id="login-link" class="btn btn--subtle" href="/login" data-i18n="nav.login">Login</a>
        <button id="logout-btn" class="btn btn--ghost" style="display:none" data-i18n="nav.logout">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="row">
      <div class="col-12">
        <div class="card">
          <h1 data-i18n="admin.panel">Admin Panel</h1>
          <p style="color:var(--tx-1)" data-i18n="admin.panel_hint">Manage moderation queues and tags. Restricted to admin and moderator roles.</p>
          <div class="flex ai-c" style="gap:8px; flex-wrap:wrap; margin-top:12px">
            <a id="i18n-link" class="btn btn--subtle" href="/admin/i18n" style="display:none" data-i18n="admin.i18n">Translations</a>
            <a id="moderation-link" class="btn btn--subtle" href="/admin/moderation" style="display:none">Moderation</a>
            <a id="user-access-link" class="btn btn--subtle" href="/admin/users" style="display:none">User access</a>
            <a id="tags-link" class="btn btn--subtle" href="/admin/tags" style="display:none">Tags</a>
          </div>
        </div>
      </div>
    </section>

    <section class="row">
      <div class="col-12">
        <div class="card">
          <h2 data-i18n="admin.tags" style="margin:0 0 12px">Tag Management</h2>
          <div class="flex ai-c" style="gap:8px; margin-bottom:12px">
            <input id="q-tag-admin" class="input" placeholder="Search tags..." data-i18n-placeholder="home.search_tags" style="max-width:240px">
            <button id="btn-search-tags" class="btn btn--subtle" data-i18n="dashboard.search">Search</button>
          </div>
          <div id="tag-create-row" class="flex ai-c" style="gap:8px; margin-bottom:16px;">
            <input id="new-tag" class="input" placeholder="New tag label" data-i18n-placeholder="admin.new_tag_placeholder" style="max-width:240px">
            <button id="btn-create-tag" class="btn" data-i18n="admin.create_tag">Create Tag</button>
          </div>
          <div id="tags-list" class="tags-list"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site">
    <div class="inner container flex ai-c jc-b">
      <div> <span id="year"></span> inTXTonic</div>
      <div class="hide-sm">Built with Windsurf guidelines</div>
    </div>
  </footer>

  <script type="module">
    import { authHeaders, getToken, clearToken } from '/src/frontend/js/auth.js';
    import { showToast } from '/src/frontend/js/toast.js';
    import { t } from '/src/frontend/js/i18n-runtime.js';

    document.getElementById('year').textContent = new Date().getFullYear().toString();

    // Auth UI
    const loginLink = document.getElementById('login-link');
    const logoutBtn = document.getElementById('logout-btn');
    function refreshAuthUI(){ const has = !!getToken(); loginLink.style.display = has?'none':'inline-flex'; logoutBtn.style.display = has?'inline-flex':'none'; }
    logoutBtn.addEventListener('click', async () => {
      try { await fetch('/auth/logout', { method: 'POST', headers: { ...authHeaders() } }); } catch {}
      clearToken();
      showToast(t('toast.signed_out'),'ok');
      window.location.href = '/';
    });
    refreshAuthUI();

    // Admin Tags: combined usage + management
    const elTagsList = document.getElementById('tags-list');
    const moderationLink = document.getElementById('moderation-link');
    let isAdmin = false;
    let lastQuery = '';

    async function renderTags(rows){
      const html = rows.map(t => {
        const restrictedBadge = t.is_restricted ? '<span class="badge badge--warn">restricted</span>' : '';
        const right = isAdmin
          ? `<div class="flex ai-c" style="gap:8px">
              <button class="btn btn--subtle toggle-ban" data-id="${t.id}" data-banned="${t.is_banned}">${t.is_banned ? 'Unban' : 'Ban'}</button>
              ${t.is_restricted ? `<button class="btn btn--ghost unrestrict-tag" data-id="${t.id}">Open tag</button>` : ''}
            </div>`
          : '';
        return `
          <div class="flex ai-c jc-b" style="padding:6px 0; border-bottom:1px solid rgba(185,236,255,.12)">
            <div class="flex ai-c" style="gap:8px">
              <span class="badge">#${t.slug}</span>
              <span>${t.label || ''}</span>
              ${t.is_banned ? '<span class="badge badge--err">banned</span>' : ''}
              ${restrictedBadge}
            </div>
            ${right}
          </div>
        `;
      }).join('');
      elTagsList.innerHTML = html || '<div class="badge">No tags</div>';
      // Wire up toggles
      if(isAdmin){
        elTagsList.querySelectorAll('button.toggle-ban').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            const banned = btn.getAttribute('data-banned') === 'true';
            const endpoint = banned ? `/tags/${id}/unban` : `/tags/${id}/ban`;
            try{
              const res = await fetch(endpoint, { method: 'POST', headers: { ...authHeaders() } });
              if(!res.ok) throw new Error(await res.text());
              showToast(banned ? 'Tag unbanned' : 'Tag banned', 'ok');
              await loadTagsCombined(lastQuery);
            }catch(err){ showToast('Failed to toggle', 'err'); }
          });
        });
      }
    }

    async function loadTagsCombined(query=''){
      lastQuery = query || '';
      elTagsList.innerHTML = '<div class="badge">Loading…</div>';
      try{
        const url = query ? `/tags/usage?query=${encodeURIComponent(query)}&limit=500` : '/tags/usage?limit=500';
        const res = await fetch(url, { headers:{ ...authHeaders() }, credentials: 'same-origin' });
        if(!res.ok){ throw new Error(await res.text()); }
        const rows = await res.json();
        await renderTags(rows || []);
      }catch(err){
        elTagsList.innerHTML = '<div class="badge badge--err">Failed to load tags</div>';
      }
    }

    // Create a new tag via API
    const tagCreateRow = document.getElementById('tag-create-row');
    const btnCreateTag = document.getElementById('btn-create-tag');
    let creatingTag = false;
    if(btnCreateTag){
      btnCreateTag.addEventListener('click', async () => {
        if(creatingTag) return;
        if(!isAdmin){ showToast('Admins only', 'warn'); return; }
        const inp = document.getElementById('new-tag');
        const newTag = inp.value.trim();
        if (!newTag) { showToast('Please enter a tag label', 'warn'); return; }
        creatingTag = true;
        try{
          const res = await fetch('/tags', { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeaders() }, body: JSON.stringify({ label: newTag }) });
          if(!res.ok) throw new Error(await res.text());
          inp.value = '';
          showToast('Tag created', 'ok');
          await loadTagsCombined();
        }catch(err){
          showToast('Create failed', 'err');
        }finally{
          creatingTag = false;
        }
      });
    }

    // Search handler for combined list
    const btnSearchTags = document.getElementById('btn-search-tags');
    const qTagAdmin = document.getElementById('q-tag-admin');
    btnSearchTags?.addEventListener('click', () => loadTagsCombined(qTagAdmin.value));
    qTagAdmin?.addEventListener('keydown', (e) => { if(e.key==='Enter'){ loadTagsCombined(qTagAdmin.value); }});
    // Check if user has admin or moderator role
    async function checkAdminAccess() {
      try {
        const res = await fetch('/auth/me', { headers: { ...authHeaders() } });
        if (!res.ok) {
          // Not authenticated – redirect to login
          window.location.href = '/login';
          return false;
        }
        const user = await res.json();
        // Allow access for admin or moderator
        if (!user.is_admin && !(Array.isArray(user.roles) && user.roles.includes('moderator'))) {
          showToast(t('toast.access_denied'), 'err');
          return false;
        }
        isAdmin = !!user.is_admin;
        // Hide create controls for non-admins
        if (!isAdmin && tagCreateRow) tagCreateRow.style.display = 'none';
        // show Translations link for admins/moderators
        const i18nLink = document.getElementById('i18n-link');
        if (i18nLink) i18nLink.style.display = 'inline-flex';
        if (moderationLink) moderationLink.style.display = 'inline-flex';
        const userAccessLink = document.getElementById('user-access-link');
        if (userAccessLink) userAccessLink.style.display = 'inline-flex';
        const tagsLink = document.getElementById('tags-link');
        if (tagsLink) tagsLink.style.display = 'inline-flex';
        return true;
      } catch (err) {
        showToast(t('toast.verify_failed'), 'err');
        return false;
      }
    }

    (async () => {
      const ok = await checkAdminAccess();
      if (ok) {
        try {
          await Promise.all([
            loadTagsCombined(''),
          ]);
        } catch (err) {
          console.error('Admin data load failed', err);
          showToast('Unable to load admin data right now', 'warn');
        }
      }
    })();
  </script>
</body>
</html>
