<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>inTXTonic • Home</title>
  <link rel="icon" type="image/svg+xml" href="/src/frontend/assets/favicon.svg">
  <!-- Inline critical preloader styles to prevent FOUC -->
  <style>
    /* Prevent FOUC - hide everything until preloader is ready */
    html { visibility: hidden !important; }
    body:not(.preloader-ready) { visibility: hidden !important; }
    .preloader {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      background: #ffffff !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 9999 !important;
      transition: opacity 0.3s ease-out !important;
      visibility: visible !important;
    }
    .preloader--hidden {
      opacity: 0 !important;
      pointer-events: none !important;
    }
    .preloader__content {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      gap: 1rem !important;
    }
    .preloader__spinner {
      width: 40px !important;
      height: 40px !important;
      border: 3px solid #e5e7eb !important;
      border-top: 3px solid #ff7a1a !important;
      border-radius: 50% !important;
      animation: spin 1s linear infinite !important;
    }
    .preloader__text {
      font-size: 0.9rem !important;
      color: #6b7280 !important;
      font-weight: 500 !important;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    body.preloader-ready {
      visibility: visible !important;
    }
    body.preloader-ready .preloader {
      opacity: 1 !important;
    }
    body.styles-loaded {
      visibility: visible !important;
    }
    body.styles-loaded .preloader {
      opacity: 0 !important;
      pointer-events: none !important;
    }
    /* Fix h1 elements */
    h1 { font-size: 1.75rem !important; margin: 0 0 0.5rem 0 !important; }
  </style>
  <link rel="stylesheet" href="/src/frontend/css/base.css">
  <link rel="stylesheet" href="/src/frontend/css/components.css">
  <link rel="stylesheet" href="/src/frontend/css/layout.css">
  <link rel="stylesheet" href="/src/frontend/css/components/preloader.css">
  <link rel="stylesheet" href="/src/frontend/css/pages/home.css">
  <script type="module" src="/src/frontend/js/preloader.js"></script>
  <script type="module" src="/src/frontend/js/i18n-runtime.js" data-i18n-init></script>
</head>
<body>
  <header class="site">
    <div class="inner container nav-3">
      <div class="left flex ai-c" style="gap:8px">
        <a class="btn btn--subtle" href="/dashboard/" data-i18n="nav.dashboard">Dashboard</a>
        <a id="newpost-link" class="btn" href="/create" style="display:none" data-i18n="nav.new_post">New Post</a>
      </div>
      <nav class="flex" style="gap:8px">
        <a class="btn btn--ghost" href="/notifications" aria-label="Notifications">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 8a6 6 0 0 0-12 0c0 7-3 7-3 7h18s-3 0-3-7" />
            <path d="M13.73 21a2 2 0 0 1-3.46 0" />
          </svg>
        </a>
        <a id="admin-link" class="btn btn--subtle" href="/admin" style="display:none" data-i18n="nav.admin">Admin</a>
        <a id="profile-link" class="btn btn--subtle" href="#" style="display:none" data-i18n="nav.profile">Profile</a>
        <button id="logout-btn" class="btn btn--ghost" data-i18n="nav.logout">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="card welcome-card" id="welcome-card">
      <h1 id="welcome-heading" data-i18n="home.welcome_back_default">Welcome back to inTXTonic</h1>
      <p id="welcome-subheading" data-i18n="home.welcome_subheading_default">Dive into the latest translations, summaries, and conversations crafted by the community.</p>
      <div class="welcome-links" style="margin-top:1.5rem">
        <h2 data-i18n="home.quick_links">Quick links</h2>
        <ul class="home-links">
          <li><a href="/dashboard/" data-i18n="home.discover_trending">Discover trending posts</a></li>
          <li><a href="/tags/top" data-i18n="home.browse_top_tags">Browse top tags</a></li>
          <li><a href="/notifications" data-i18n="home.check_notifications">Check your notifications</a></li>
        </ul>
        <p class="hint" data-i18n="home.try_ai">Tip: translate or summarise any post instantly using the AI tools in the post toolbar.</p>
      </div>
    </section>

    <section class="card home-section" aria-labelledby="home-latest-heading">
      <div class="home-section-head">
        <h2 id="home-latest-heading" data-i18n="home.latest_for_you">Latest for you</h2>
        <a href="/dashboard/" class="link link--subtle" data-i18n="home.view_full_feed">View full feed</a>
      </div>
      <div id="auth-latest-posts" class="home-posts-grid" role="list"></div>
    </section>
  </main>

  <footer class="site">
    <div class="inner container flex ai-c jc-b">
      <div>&copy; <a href="https://bubuit.net/" class="link">bubuit.net</a></div>
      <div class="hide-sm">Built with <a href="https://windsurf.com/refer?referral_code=4j75hl1x7ibz3yj8" class="link">Windsurf</a> guidelines &middot; <a href="https://github.com/oib/intxtonic" class="link">GitHub</a></div>
    </div>
  </footer>

  <script type="module">
    import { authHeaders, getToken, clearToken } from '/src/frontend/js/auth.js';
    import { showToast } from '/src/frontend/js/toast.js';
    import { t } from '/src/frontend/js/i18n-runtime.js';
    import preloader from '/src/frontend/js/preloader.js';

    // Initialize preloader
    preloader.init();

    const logoutBtn = document.getElementById('logout-btn');
    const profileLink = document.getElementById('profile-link');
    const adminLink = document.getElementById('admin-link');
    const newPostLink = document.getElementById('newpost-link');
    const welcomeHeading = document.getElementById('welcome-heading');
    const welcomeSubheading = document.getElementById('welcome-subheading');
    const latestPosts = document.getElementById('auth-latest-posts');

    if (profileLink) {
      const defaultLabel = profileLink.dataset.defaultLabel || profileLink.textContent || 'Profile';
      profileLink.dataset.defaultLabel = defaultLabel;
      profileLink.textContent = defaultLabel;
      profileLink.style.display = 'none';
    }

    logoutBtn.addEventListener('click', async () => {
      try {
        await fetch('/auth/logout', { method: 'POST', headers: { ...authHeaders() } });
      } catch {}
      clearToken();
      showToast(t('toast.signed_out'), 'ok');
      window.location.href = '/';
    });

    function renderPostsSkeleton(){
      latestPosts.innerHTML = '<div class="skeleton"></div>'.repeat(3);
    }

    const sanitisePreview = (md = '') => {
      return md
        .replace(/!\[[^\]]*\]\([^)]*\)/g, '')
        .replace(/<img[^>]*>/gi, '')
        .replace(/\s+/g, ' ')
        .trim();
    };

    async function loadLatestForUser(){
      renderPostsSkeleton();
      try {
        const params = new URLSearchParams({ sort: 'newest', limit: '6' });
        const res = await fetch(`/posts?${params.toString()}`, { headers: { ...authHeaders() } });
        if (res.status === 401){
          clearToken();
          window.location.href = '/login/';
          return;
        }
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items.slice(0,6) : [];
        if (!items.length){
          latestPosts.innerHTML = '<div class="badge">No posts yet. Start by creating your first one!</div>';
          return;
        }
        latestPosts.innerHTML = items.map(item => {
          const previewSrc = sanitisePreview(item.body_md || '');
          const preview = previewSrc.slice(0, 200);
          const ellipsis = previewSrc.length > 200 ? '…' : '';
          return `
          <article class="home-post" role="listitem">
            <a class="home-post__title" href="/post/${item.id}">${item.title}</a>
            <div class="home-post__meta">${item.author ? `by ${item.author}` : 'by someone'}${item.created_at ? ` · ${new Date(item.created_at).toLocaleDateString()}` : ''}</div>
            <p class="home-post__excerpt">${preview}${ellipsis}</p>
            <div class="home-post__tags">
              ${(Array.isArray(item.tags) ? item.tags : []).filter(t => !t.is_restricted).slice(0,3).map(tag => `<a href="/tags/${encodeURIComponent(tag.slug)}" class="badge badge--link">#${tag.slug}</a>`).join('')}
            </div>
          </article>
        `}).join('');
      } catch (err){
        latestPosts.innerHTML = '<div class="badge badge--err">Unable to load personalised posts right now.</div>';
      }
    }

    async function init(){
      const token = getToken();
      if (!token){
        window.location.href = '/login/';
        return;
      }
      try {
        const res = await fetch('/auth/me', { headers: { ...authHeaders() } });
        if (res.status === 401){
          clearToken();
          window.location.href = '/login/';
          return;
        }
        if (!res.ok) throw new Error('Failed to load profile');
        const user = await res.json();
        newPostLink.style.display = 'inline-flex';
        if (profileLink) {
          profileLink.style.display = 'inline-flex';
          profileLink.href = `/user/${encodeURIComponent(user.handle)}`;
          const label = (user.display_name || user.handle || '').trim();
          const defaultLabel = profileLink.dataset.defaultLabel || 'Profile';
          profileLink.textContent = label || defaultLabel;
        }
        const displayName = (user.display_name || '').trim();
        const handle = (user.handle || '').trim();
        const greetingName = displayName || handle || t('nav.profile');
        const subheadingHandle = handle || greetingName;
        welcomeHeading.textContent = t('home.welcome_back_user', { name: greetingName });
        welcomeSubheading.textContent = t('home.welcome_subheading_user', { handle: subheadingHandle });
        if (adminLink) {
          const isAdmin = user.is_admin || (Array.isArray(user.roles) && user.roles.includes('admin'));
          adminLink.style.display = isAdmin ? 'inline-flex' : 'none';
          adminLink.parentElement.style.justifyContent = isAdmin ? 'center' : '';
          adminLink.parentElement.style.gap = isAdmin ? '12px' : '8px';
        }
      } catch (err){
        clearToken();
        window.location.href = '/login/';
        return;
      }
      await loadLatestForUser();
    }

    init();
  </script>
  <!-- Inline preloader initialization - runs after body is available -->
  <script>
    // Initialize preloader immediately after body is parsed
    function initPreloader() {
      if (document.body) {
        // Show preloader and make content visible
        document.documentElement.style.visibility = 'visible';
        document.body.classList.add('preloader-ready');
      } else {
        // Fallback if body is still not available
        document.addEventListener('DOMContentLoaded', function() {
          document.documentElement.style.visibility = 'visible';
          document.body.classList.add('preloader-ready');
        });
      }
    }
    
    // Run immediately
    initPreloader();
  </script>
</body>
</html>
