<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>inTXTonic • Admin Tags</title>
  <link rel="stylesheet" href="/src/frontend/css/base.css">
  <link rel="stylesheet" href="/src/frontend/css/components.css">
  <link rel="stylesheet" href="/src/frontend/css/layout.css">
</head>
<body>
  <header class="site">
    <div class="inner container nav-3">
      <div class="left flex ai-c" style="gap:8px">
        <a class="btn btn--subtle" href="/admin">← Back to admin</a>
      </div>
      <nav class="flex ai-c" style="gap:8px">
        <a class="btn btn--subtle" href="/dashboard">Dashboard</a>
        <a id="login-link" class="btn btn--subtle" href="/login">Login</a>
        <button id="logout-btn" class="btn btn--ghost" style="display:none">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="row">
      <div class="col-12">
        <div class="card">
          <h1>Tag Overview</h1>
          <p class="hint" style="color:var(--tx-1)">Admins can review tag groups created by staff vs community members.</p>
        </div>
      </div>
    </section>

    <section class="row">
      <div class="col-12">
        <div class="card">
          <div class="flex ai-c jc-b" style="gap:12px; flex-wrap:wrap">
            <h2 style="margin:0">Admin-created tags</h2>
            <button id="refresh-btn" class="btn btn--subtle" type="button">Refresh</button>
          </div>
          <div id="admin-tags" class="tags-list" style="margin-top:12px"></div>
        </div>
      </div>
    </section>

    <section class="row">
      <div class="col-12">
        <div class="card">
          <h2 style="margin:0 0 12px">User-created tags</h2>
          <div id="user-tags" class="tags-list"></div>
        </div>
      </div>
    </section>

    <section class="row">
      <div class="col-12">
        <div class="card">
          <h2 style="margin:0 0 12px">Tag Visibility</h2>
          <div class="flex ai-c" style="gap:8px; margin-bottom:12px">
            <input id="q-tag-visibility" class="input" placeholder="Filter tags" style="max-width:240px">
            <button id="btn-search-visibility" class="btn btn--subtle" type="button">Filter</button>
          </div>
          <div id="tag-visibility" class="tags-list"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site">
    <div class="inner container flex ai-c jc-b">
      <div><span id="year"></span> inTXTonic</div>
    </div>
  </footer>

  <script type="module">
    import { authHeaders, getToken, clearToken, refreshAuthUI } from '/src/frontend/js/auth.js';
    import { showToast } from '/src/frontend/js/toast.js';

    window.addEventListener('load', () => {
      window.requestAnimationFrame(() => {
        const logoutBtn = document.getElementById('logout-btn');
        const yearEl = document.getElementById('year');
        const adminTagsEl = document.getElementById('admin-tags');
        const userTagsEl = document.getElementById('user-tags');
        const refreshBtn = document.getElementById('refresh-btn');
        const tagVisibilityEl = document.getElementById('tag-visibility');
        const qTagVisibility = document.getElementById('q-tag-visibility');
        const btnSearchVisibility = document.getElementById('btn-search-visibility');
        let lastVisibilityQuery = '';

        if (yearEl) {
          yearEl.textContent = new Date().getFullYear().toString();
        }

        const TAG_TEMPLATE = (tag) => `
          <div class="flex ai-c jc-b" style="padding:8px 0; border-bottom:1px solid rgba(185,236,255,.12)">
            <div class="flex ai-c" style="gap:8px; flex-wrap:wrap">
              <span class="badge">#${tag.slug}</span>
              <span>${tag.label || ''}</span>
              ${tag.is_banned ? '<span class="badge badge--err">banned</span>' : ''}
              ${tag.is_restricted ? '<span class="badge badge--warn">restricted</span>' : ''}
            </div>
            <div class="flex fd-c" style="gap:4px; text-align:right">
              ${tag.created_at ? `<span class="hint">${new Date(tag.created_at).toLocaleString()}</span>` : ''}
            </div>
          </div>
        `;

        function renderTagList(el, tags, emptyMsg) {
          if (!tags || !tags.length) {
            el.innerHTML = `<div class="badge">${emptyMsg}</div>`;
            return;
          }
          el.innerHTML = tags.map(TAG_TEMPLATE).join('');
        }

        async function fetchTagGroups() {
          adminTagsEl.innerHTML = '<div class="badge">Loading…</div>';
          userTagsEl.innerHTML = '<div class="badge">Loading…</div>';
          try {
            const res = await fetch('/tags/admin/groups', { headers: { ...authHeaders() } });
            if (res.status === 401 || res.status === 403) {
              showToast('Admin access required', 'err');
              window.location.href = '/admin';
              return;
            }
            if (!res.ok) {
              throw new Error(await res.text());
            }
            const data = await res.json();
            renderTagList(adminTagsEl, data?.admin_created || [], 'No admin-created tags');
            renderTagList(userTagsEl, data?.user_created || [], 'No user-created tags');
          } catch (err) {
            console.error('Failed to load tag groups', err);
            adminTagsEl.innerHTML = '<div class="badge badge--err">Failed to load tags</div>';
            userTagsEl.innerHTML = '<div class="badge badge--err">Failed to load tags</div>';
          }
        }

        async function ensureAdmin() {
          if (!getToken()) {
            window.location.href = '/login';
            return false;
          }
          try {
            const res = await fetch('/auth/me', { headers: { ...authHeaders() } });
            if (!res.ok) {
              window.location.href = '/login';
              return false;
            }
            const me = await res.json();
            const isAdmin = !!me.is_admin || (Array.isArray(me.roles) && me.roles.includes('moderator'));
            if (!isAdmin) {
              showToast('Admin access required', 'err');
              window.location.href = '/admin';
              return false;
            }
            return true;
          } catch (err) {
            console.error('Failed to verify admin', err);
            showToast('Unable to verify access', 'err');
            window.location.href = '/admin';
            return false;
          }
        }

        function normalizeHandleInput(value = '') {
          const trimmed = value.trim();
          if (!trimmed) return '';
          return trimmed.startsWith('@') ? trimmed.slice(1) : trimmed;
        }

        function setTagStatusMessage(tagId, message, tone = 'info') {
          const statusEl = tagVisibilityEl?.querySelector(`.tag-vis-status[data-tag-id="${tagId}"]`);
          if (!statusEl) return;
          statusEl.textContent = message;
          const baseClass = 'tag-vis-status badge';
          const toneClass = tone === 'err' ? ' badge--err' : tone === 'warn' ? ' badge--warn' : '';
          statusEl.className = baseClass + toneClass;
          statusEl.style.display = message ? 'inline-block' : 'none';
        }

        function clearTagStatusMessage(tagId) {
          setTagStatusMessage(tagId, '');
        }

        function renderTagVisibility(rows) {
          if (!tagVisibilityEl) return;
          const html = rows.map((t) => {
            const rolesHtml = t.roles.length
              ? t.roles.map((r) => `<span class="badge">${r.name}</span>`).join(' ')
              : '<span class="badge">none</span>';
            const usersHtml = t.users.length
              ? t.users
                  .map(
                    (u) => `
              <div class="flex ai-c" style="gap:6px">
                <span class="badge">@${u.handle}</span>
                <button type="button" class="btn btn--ghost tag-vis-remove-user" data-tag-id="${t.tag_id}" data-handle="${u.handle}">Remove</button>
              </div>
            `
                  )
                  .join('')
              : '<div class="badge">No user overrides</div>';
            return `
          <div class="tag-vis-row" data-tag-id="${t.tag_id}" data-tag-slug="${t.slug}" style="padding:12px 0; border-bottom:1px solid rgba(185,236,255,.12)">
            <div class="flex ai-c jc-b" style="gap:16px; flex-wrap:wrap">
              <div class="flex ai-c" style="gap:8px">
                <span class="badge">#${t.slug}</span>
                <span>${t.label || ''}</span>
              </div>
              <div class="flex ai-c" style="gap:8px; flex-wrap:wrap">
                <strong>Roles</strong>
                <div class="flex ai-c" style="gap:6px; flex-wrap:wrap">${rolesHtml}</div>
              </div>
            </div>
            <div class="tag-vis-users" style="margin-top:12px">
              <div><strong>Users</strong></div>
              <div class="tag-vis-user-list" style="margin-top:6px; display:flex; flex-direction:column; gap:6px">
                ${usersHtml}
              </div>
              <form class="tag-vis-add-user flex" data-tag-id="${t.tag_id}" style="gap:8px; flex-wrap:wrap; margin-top:12px">
                <input name="handle" class="input" placeholder="Add @handle" autocomplete="off" style="max-width:220px">
                <button class="btn btn--subtle" type="submit">Grant access</button>
              </form>
              <div class="tag-vis-status badge" data-tag-id="${t.tag_id}" style="display:none; margin-top:8px"></div>
            </div>
          </div>
        `;
          }).join('');
          tagVisibilityEl.innerHTML = html || '<div class="badge">No visibility overrides</div>';

          tagVisibilityEl.querySelectorAll('.tag-vis-add-user').forEach((form) => {
            form.addEventListener('submit', handleTagUserGrant);
          });
          tagVisibilityEl.querySelectorAll('.tag-vis-remove-user').forEach((btn) => {
            btn.addEventListener('click', handleTagUserRemoval);
          });
        }

        async function handleTagUserGrant(event) {
          event.preventDefault();
          const form = event.currentTarget;
          const tagId = form.getAttribute('data-tag-id');
          if (!tagId) return;
          const input = form.querySelector('input[name="handle"]');
          const submitBtn = form.querySelector('button[type="submit"]');
          const slug = form.closest('.tag-vis-row')?.getAttribute('data-tag-slug') || '';
          const handle = normalizeHandleInput(input?.value || '');
          if (!handle) {
            setTagStatusMessage(tagId, 'Enter a user handle', 'warn');
            return;
          }
          clearTagStatusMessage(tagId);
          setTagStatusMessage(tagId, `Granting #${slug} to @${handle}…`);
          if (submitBtn) submitBtn.disabled = true;
          try {
            const res = await fetch(`/tags/${encodeURIComponent(tagId)}/visibility/users`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', ...authHeaders() },
              body: JSON.stringify({ handle }),
            });
            if (res.status === 404) {
              const text = await res.text();
              if (text.includes('Tag not found')) {
                setTagStatusMessage(tagId, 'Tag no longer exists', 'err');
              } else {
                setTagStatusMessage(tagId, 'User not found', 'warn');
              }
              return;
            }
            if (res.status === 400) {
              const text = await res.text();
              setTagStatusMessage(tagId, text || 'Invalid handle', 'warn');
              return;
            }
            if (!res.ok) {
              throw new Error(await res.text());
            }
            showToast(`Granted #${slug} to @${handle}`, 'ok');
            if (input) input.value = '';
            await loadTagVisibility(lastVisibilityQuery);
          } catch (err) {
            console.error('assign tag failed', err);
            setTagStatusMessage(tagId, 'Failed to grant access', 'err');
          } finally {
            if (submitBtn) submitBtn.disabled = false;
          }
        }

        async function handleTagUserRemoval(event) {
          event.preventDefault();
          const btn = event.currentTarget;
          const tagId = btn.getAttribute('data-tag-id');
          const handle = btn.getAttribute('data-handle');
          if (!tagId || !handle) return;
          const slug = btn.closest('.tag-vis-row')?.getAttribute('data-tag-slug') || '';
          setTagStatusMessage(tagId, `Removing @${handle}…`);
          btn.disabled = true;
          try {
            const res = await fetch(`/tags/${encodeURIComponent(tagId)}/visibility/users/${encodeURIComponent(handle)}`, {
              method: 'DELETE',
              headers: { ...authHeaders() },
            });
            if (res.status === 404) {
              const text = await res.text();
              if (text.includes('Tag not found')) {
                setTagStatusMessage(tagId, 'Tag no longer exists', 'err');
              } else {
                setTagStatusMessage(tagId, 'User not found', 'warn');
              }
              return;
            }
            if (!res.ok) {
              throw new Error(await res.text());
            }
            showToast(`Removed #${slug} for @${handle}`, 'ok');
            await loadTagVisibility(lastVisibilityQuery);
          } catch (err) {
            console.error('remove tag visibility failed', err);
            setTagStatusMessage(tagId, 'Failed to remove access', 'err');
          } finally {
            btn.disabled = false;
          }
        }

        async function loadTagVisibility(query = '') {
          if (!tagVisibilityEl) return;
          lastVisibilityQuery = query || '';
          tagVisibilityEl.innerHTML = '<div class="badge">Loading…</div>';
          try {
            const url = query ? `/tags/visibility?query=${encodeURIComponent(query)}` : '/tags/visibility';
            const res = await fetch(url, { headers: { ...authHeaders() } });
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            renderTagVisibility(Array.isArray(data) ? data : []);
          } catch (err) {
            console.error('loadTagVisibility failed', err);
            tagVisibilityEl.innerHTML = '<div class="badge badge--err">Failed to load tag visibility</div>';
          }
        }

        if (logoutBtn) {
          logoutBtn.addEventListener('click', async () => {
            try {
              await fetch('/auth/logout', { method: 'POST', headers: { ...authHeaders() } });
            } catch (err) {}
            clearToken();
            showToast('Signed out', 'ok');
            window.location.href = '/';
          });
        }

        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => { fetchTagGroups(); });
        }

        if (btnSearchVisibility) {
          btnSearchVisibility.addEventListener('click', () => { loadTagVisibility(qTagVisibility?.value || ''); });
        }

        if (qTagVisibility) {
          qTagVisibility.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              loadTagVisibility(qTagVisibility.value);
            }
          });
        }

        refreshAuthUI();
        ensureAdmin().then((ok) => {
          if (ok) {
            fetchTagGroups();
            loadTagVisibility('');
          }
        });
      });
    });
  </script>
</body>
</html>
