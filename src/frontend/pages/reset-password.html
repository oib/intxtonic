<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>inTXTonic • Reset Password</title>
  <link rel="stylesheet" href="/src/frontend/css/base.css">
  <link rel="stylesheet" href="/src/frontend/css/components.css">
  <link rel="stylesheet" href="/src/frontend/css/layout.css">
  <style>
    main { min-height: 100dvh; display: grid; place-items: center; padding: 16px; }
    .card { max-width: 460px; width: 100%; }
  </style>
</head>
<body>
  <main class="container">
    <section class="card" id="view-request">
      <h1 class="mb-6">Forgot your password?</h1>
      <p class="hint mb-6">Enter the handle or email tied to your account. We'll email you a one-time magic login link so you can get back in.</p>
      <form id="request-form" class="grid" style="gap:16px">
        <label>
          <div class="mb-6">Handle or email</div>
          <input id="req-handle" class="input" type="text" placeholder="user1 or user@intxtonic.net" required>
        </label>
        <button class="btn btn--subtle" type="button" id="btn-request-magic">Send a magic login link</button>
        <div id="request-msg" class="badge" style="display:none"></div>
      </form>
      <p class="hint" style="margin-top:16px; color:var(--tx-1)"><a href="/login" class="link">Back to login</a></p>
    </section>

    <section class="card" id="view-reset" style="display:none">
      <h1 class="mb-6">Set a new password</h1>
      <p class="hint mb-6">Create a new password to regain access to your account.</p>
      <form id="reset-form" class="grid" style="gap:16px">
        <label>
          <div class="mb-6">New password</div>
          <input id="reset-pass" class="input" type="password" placeholder="••••••••" minlength="8" required>
        </label>
        <label>
          <div class="mb-6">Confirm password</div>
          <input id="reset-pass-confirm" class="input" type="password" placeholder="••••••••" minlength="8" required>
        </label>
        <button class="btn" type="submit">Update password</button>
        <div id="reset-msg" class="badge" style="display:none"></div>
      </form>
      <p class="hint" style="margin-top:16px; color:var(--tx-1)"><a href="/login" class="link">Back to login</a></p>
    </section>
  </main>

  <script type="module">
    import { requestMagicLink, resetPassword } from '/src/frontend/js/auth.js';
    import { showToast } from '/src/frontend/js/toast.js';

    const params = new URLSearchParams(location.search);
    const token = params.get('token');

    const requestView = document.getElementById('view-request');
    const resetView = document.getElementById('view-reset');

    const requestInput = document.getElementById('req-handle');
    const requestMsg = document.getElementById('request-msg');
    const requestMagicBtn = document.getElementById('btn-request-magic');

    const resetForm = document.getElementById('reset-form');
    const resetPass = document.getElementById('reset-pass');
    const resetPassConfirm = document.getElementById('reset-pass-confirm');
    const resetMsg = document.getElementById('reset-msg');

    function showRequestView(){
      requestView.style.display = 'block';
      resetView.style.display = 'none';
    }

    function showResetView(){
      requestView.style.display = 'none';
      resetView.style.display = 'block';
    }

    if(token){
      showResetView();
    } else {
      showRequestView();
    }

    requestMagicBtn?.addEventListener('click', async () => {
      const value = requestInput.value.trim();
      requestMsg.style.display = 'none';
      if(!value){
        requestMsg.textContent = 'Enter your handle or email first.';
        requestMsg.className = 'badge badge--warn';
        requestMsg.style.display = 'inline-block';
        return;
      }
      requestMagicBtn.disabled = true;
      try {
        await requestMagicLink(value);
        requestMsg.textContent = 'If that account exists, a magic login link is on its way.';
        requestMsg.className = 'badge';
        requestMsg.style.display = 'inline-block';
        showToast('Magic link sent', 'ok');
      } catch (err) {
        requestMsg.textContent = 'Unable to send magic link right now.';
        requestMsg.className = 'badge badge--err';
        requestMsg.style.display = 'inline-block';
        showToast('Magic link failed', 'err');
      } finally {
        setTimeout(() => { requestMagicBtn.disabled = false; }, 5000);
      }
    });

    resetForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      resetMsg.style.display = 'none';
      if(!token){
        resetMsg.textContent = 'Missing password reset token. Request a new email.';
        resetMsg.className = 'badge badge--warn';
        resetMsg.style.display = 'inline-block';
        return;
      }
      const pass = resetPass.value;
      const confirm = resetPassConfirm.value;
      if(pass !== confirm){
        resetMsg.textContent = 'Passwords do not match.';
        resetMsg.className = 'badge badge--warn';
        resetMsg.style.display = 'inline-block';
        return;
      }
      resetForm.querySelector('button[type="submit"]').disabled = true;
      try {
        await resetPassword(token, pass);
        resetMsg.textContent = 'Password updated. Redirecting you home…';
        resetMsg.className = 'badge';
        resetMsg.style.display = 'inline-block';
        showToast('Password updated', 'ok');
        setTimeout(() => { window.location.href = '/home'; }, 1500);
      } catch (err) {
        let detail = 'Unable to reset password right now.';
        if(err?.message){
          try {
            const data = JSON.parse(err.message);
            if(data?.detail) detail = data.detail;
          } catch {}
        }
        resetMsg.textContent = detail;
        resetMsg.className = 'badge badge--err';
        resetMsg.style.display = 'inline-block';
        showToast('Password reset failed', 'err');
      } finally {
        resetForm.querySelector('button[type="submit"]').disabled = false;
      }
    });
  </script>
</body>
</html>
