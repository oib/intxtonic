<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>inTXTonic • Admin Users</title>
  <link rel="stylesheet" href="/src/frontend/css/base.css">
  <link rel="stylesheet" href="/src/frontend/css/components.css">
  <link rel="stylesheet" href="/src/frontend/css/layout.css">
</head>
<body>
  <header class="site">
    <div class="inner container nav-3">
      <div class="left flex ai-c" style="gap:8px">
        <a class="btn btn--subtle" href="/admin">← Back to admin</a>
      </div>
      <nav class="flex ai-c" style="gap:8px">
        <a class="btn btn--subtle" href="/dashboard">Dashboard</a>
        <a id="login-link" class="btn btn--subtle" href="/login">Login</a>
        <button id="logout-btn" class="btn btn--ghost" style="display:none">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="row">
      <div class="col-12">
        <div class="card">
          <h1>User Management</h1>
          <p class="hint" style="color:var(--tx-1)">Admins can view users, disable accounts, and manage restricted tag access.</p>
        </div>
      </div>
    </section>

    <section class="row">
      <div class="col-12">
        <div class="card">
          <div class="flex" style="gap:12px; flex-wrap:wrap; margin-bottom:16px">
            <form id="lookup-form" class="flex" style="gap:8px; flex-wrap:wrap">
              <input id="handle-input" class="input" placeholder="User handle (e.g. user1)" autocomplete="off" required style="max-width:240px">
              <button class="btn" type="submit">Load tag overrides</button>
            </form>
            <div class="flex" style="gap:8px; flex-wrap:wrap">
              <input id="user-search" class="input" placeholder="Search users" autocomplete="off" style="max-width:240px">
              <button id="btn-refresh-users" class="btn btn--subtle" type="button">Refresh list</button>
            </div>
          </div>
          <div id="status-msg" class="badge" style="display:none"></div>

          <section id="user-list-section" style="margin-bottom:24px">
            <div class="table" role="table" aria-label="User accounts" style="overflow-x:auto">
              <table class="table-simple" style="width:100%; min-width:600px">
                <thead>
                  <tr>
                    <th style="text-align:left">Handle</th>
                    <th style="text-align:left">Email</th>
                    <th style="text-align:left">Created</th>
                    <th style="text-align:left">Status</th>
                    <th style="text-align:left">Admin</th>
                    <th style="text-align:right">Actions</th>
                  </tr>
                </thead>
                <tbody id="user-table-body">
                  <tr><td colspan="5"><span class="badge">Loading…</span></td></tr>
                </tbody>
              </table>
            </div>
            <div class="flex ai-c" style="gap:8px; margin-top:12px; flex-wrap:wrap">
              <button id="btn-prev-page" class="btn btn--subtle" type="button">Prev</button>
              <button id="btn-next-page" class="btn btn--subtle" type="button">Next</button>
              <div id="user-count" class="hint"></div>
            </div>
          </section>

          <section id="assignment-panel" style="display:none; margin-top:16px">
            <h2 id="user-heading" style="margin:0 0 12px 0"></h2>
            <form id="assign-form" class="flex" style="gap:8px; flex-wrap:wrap; margin-bottom:16px">
              <select id="tag-select" class="input" required style="min-width:220px"></select>
              <button class="btn" type="submit">Add tag</button>
            </form>
            <div id="assign-msg" class="badge" style="display:none"></div>
            <div id="user-tag-list" class="tags-list"></div>
          </section>
        </div>
      </div>
    </section>
  </main>

  <footer class="site">
    <div class="inner container flex ai-c jc-b">
      <div><span id="year"></span> inTXTonic</div>
    </div>
  </footer>

  <script type="module">
    import { authHeaders, getToken, clearToken, refreshAuthUI } from '/src/frontend/js/auth.js';
    import { showToast } from '/src/frontend/js/toast.js';
    window.addEventListener('load', () => {
      window.requestAnimationFrame(() => {
        (async () => {
          const yearEl = document.getElementById('year');
          if (yearEl) {
            yearEl.textContent = new Date().getFullYear().toString();
          }

          const lookupForm = document.getElementById('lookup-form');
          const handleInput = document.getElementById('handle-input');
          const statusMsg = document.getElementById('status-msg');
          const userSearch = document.getElementById('user-search');
          const userTableBody = document.getElementById('user-table-body');
          const userListSection = document.getElementById('user-list-section');
          const btnRefreshUsers = document.getElementById('btn-refresh-users');
          const btnPrevPage = document.getElementById('btn-prev-page');
          const btnNextPage = document.getElementById('btn-next-page');
          const userCount = document.getElementById('user-count');
          const logoutBtn = document.getElementById('logout-btn');
          const loginLink = document.getElementById('login-link');

          const assignPanel = document.getElementById('assignment-panel');
          const assignForm = document.getElementById('assign-form');
          const tagSelect = document.getElementById('tag-select');
          const assignMsg = document.getElementById('assign-msg');
          const userHeading = document.getElementById('user-heading');
          const userTagList = document.getElementById('user-tag-list');

          let currentHandle = '';
          let cachedTags = [];
          let tagsFetchedAt = 0;
          let tagsLoading = false;
          let usersLoading = false;
          let userPage = 0;
          let userTotal = 0;
          const pageSize = 25;

      function setStatus(message, tone='info'){
        statusMsg.textContent = message;
        statusMsg.className = `badge${tone === 'err' ? ' badge--err' : tone === 'warn' ? ' badge--warn' : ''}`;
        statusMsg.style.display = 'inline-block';
      }

      function hideStatus(){ statusMsg.style.display = 'none'; }

      function setAssignStatus(message, tone='info'){
        assignMsg.textContent = message;
        assignMsg.className = `badge${tone === 'err' ? ' badge--err' : tone === 'warn' ? ' badge--warn' : ''}`;
        assignMsg.style.display = 'inline-block';
      }

      function hideAssignStatus(){ assignMsg.style.display = 'none'; }

      async function checkAdminAccess(){
        if (!getToken()) {
          window.location.href = '/login';
          return false;
        }
        try{
          const res = await fetch('/auth/me', { headers:{ ...authHeaders() } });
          if(!res.ok){ window.location.href = '/login'; return false; }
          const me = await res.json();
          if (!me.is_admin && !(Array.isArray(me.roles) && me.roles.includes('moderator'))){
            showToast('Admin access required', 'err');
            window.location.href = '/admin';
            return false;
          }
          return true;
        }catch(err){
          console.error('checkAdminAccess failed', err);
          showToast('Unable to verify access', 'err');
          return false;
        }
      }

      function renderUsers(rows){
        if(!rows || !rows.length){
          userTableBody.innerHTML = '<tr><td colspan="5"><span class="badge">No users found</span></td></tr>';
          return;
        }
        userTableBody.innerHTML = rows.map(user => {
          const status = user.disabled_at ? '<span class="badge badge--warn">Disabled</span>' : '<span class="badge">Active</span>';
          const created = user.created_at ? new Date(user.created_at).toLocaleString() : '';
          const email = user.email ? user.email : '<span class="hint">(none)</span>';
          const actions = user.disabled_at
            ? `<button class="btn btn--subtle" data-action="enable" data-id="${user.id}">Enable</button>`
            : `<button class="btn btn--danger" data-action="disable" data-id="${user.id}">Disable</button>`;
          return `
            <tr>
              <td>@${user.handle}</td>
              <td>${email}</td>
              <td>${created}</td>
              <td>${status}</td>
              <td>${user.is_admin ? '<span class="badge">Yes</span>' : '<span class="badge badge--subtle">No</span>'}</td>
              <td style="text-align:right; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap">
                ${actions}
                <button class="btn btn--ghost" data-action="load-tags" data-handle="${user.handle}">Tag access</button>
              </td>
            </tr>
          `;
        }).join('');

        userTableBody.querySelectorAll('button[data-action]').forEach(btn => {
          const action = btn.dataset.action;
          if(action === 'disable'){
            btn.addEventListener('click', () => handleDisable(btn.dataset.id));
          }else if(action === 'enable'){
            btn.addEventListener('click', () => handleEnable(btn.dataset.id));
          }else if(action === 'load-tags'){
            btn.addEventListener('click', () => {
              handleInput.value = btn.dataset.handle;
              loadAssignments(btn.dataset.handle);
            });
          }
        });
      }

      async function loadUsers(){
        if(usersLoading) return;
        usersLoading = true;
        userTableBody.innerHTML = '<tr><td colspan="5"><span class="badge">Loading…</span></td></tr>';
        const q = userSearch.value.trim();
        const params = new URLSearchParams({
          limit: String(pageSize),
          offset: String(userPage * pageSize),
        });
        if(q) params.set('q', q);
        try{
          const res = await fetch(`/users/admin?${params.toString()}`, { headers:{ ...authHeaders() } });
          if(res.status === 403){
            showToast('Admin access required', 'err');
            window.location.href = '/admin';
            return;
          }
          if(!res.ok) throw new Error(await res.text());
          const data = await res.json();
          const rows = Array.isArray(data.items) ? data.items : [];
          userTotal = typeof data.total === 'number' ? data.total : rows.length;
          renderUsers(rows);
          updatePaging();
        }catch(err){
          console.error('loadUsers failed', err);
          userTableBody.innerHTML = '<tr><td colspan="5"><span class="badge badge--err">Failed to load users</span></td></tr>';
          showToast('Failed to load users', 'err');
        }finally{
          usersLoading = false;
        }
      }

      function updatePaging(){
        const start = userPage * pageSize + 1;
        const end = Math.min((userPage + 1) * pageSize, userTotal);
        if(userTotal === 0){
          userCount.textContent = '0 users';
        }else{
          userCount.textContent = `${start}-${end} of ${userTotal}`;
        }
        btnPrevPage.disabled = userPage === 0;
        btnNextPage.disabled = (userPage + 1) * pageSize >= userTotal;
      }

      async function handleDisable(accountId){
        if(!accountId) return;
        const confirmed = window.confirm('Disable this account? The user will no longer be able to sign in.');
        if(!confirmed) return;
        try{
          const res = await fetch(`/users/admin/${encodeURIComponent(accountId)}/disable`, {
            method: 'POST',
            headers: { ...authHeaders() }
          });
          if(!res.ok) throw new Error(await res.text());
          showToast('Account disabled', 'ok');
          await loadUsers();
        }catch(err){
          console.error('disable account failed', err);
          showToast('Unable to disable account', 'err');
        }
      }

      async function handleEnable(accountId){
        if(!accountId) return;
        try{
          const res = await fetch(`/users/admin/${encodeURIComponent(accountId)}/enable`, {
            method: 'POST',
            headers: { ...authHeaders() }
          });
          if(!res.ok) throw new Error(await res.text());
          showToast('Account enabled', 'ok');
          await loadUsers();
        }catch(err){
          console.error('enable account failed', err);
          showToast('Unable to enable account', 'err');
        }
      }

      async function loadTags(force=false){
        if(tagsLoading) return;
        if(!force && tagsFetchedAt && Date.now() - tagsFetchedAt < 5_000){
          return;
        }
        tagsLoading = true;
        tagSelect.innerHTML = '<option value="">Loading…</option>';
        try{
          const res = await fetch('/tags?limit=500', { headers:{ ...authHeaders() } });
          if(!res.ok) throw new Error(await res.text());
          const fetched = await res.json();
          cachedTags = Array.isArray(fetched) ? fetched : [];
          const restrictedTags = cachedTags.filter(t => t && t.is_restricted);
          cachedTags = restrictedTags;
          tagsFetchedAt = Date.now();
          if(!restrictedTags.length){
            tagSelect.innerHTML = '<option value="">No restricted tags available</option>';
            tagsLoading = false;
            return;
          }
          const prevValue = tagSelect.value;
          const optionsHtml = restrictedTags
            .map(t => `<option value="${t.id}">#${t.slug} — ${t.label || ''}</option>`)
            .join('');
          tagSelect.innerHTML = `<option value="" disabled selected>Select a restricted tag…</option>${optionsHtml}`;
          if(prevValue && restrictedTags.some(t => String(t.id) === prevValue)){
            tagSelect.value = prevValue;
          }
        }catch(err){
          console.error('loadTags failed', err);
          tagSelect.innerHTML = '<option value="">Failed to load tags</option>';
          showToast('Failed to load tags', 'err');
          tagsFetchedAt = 0;
        }finally{
          tagsLoading = false;
        }
      }

      tagSelect.addEventListener('focus', () => { loadTags(true); });

      async function loadAssignments(handle){
        if(!handle){
          assignPanel.style.display = 'none';
          return;
        }
        userTagList.innerHTML = '<div class="badge">Loading…</div>';
        hideAssignStatus();
        try{
          const res = await fetch(`/tags/visibility/users/${encodeURIComponent(handle)}`, { headers:{ ...authHeaders() } });
          if(res.status === 404){
            userTagList.innerHTML = '<div class="badge badge--warn">User not found</div>';
            assignPanel.style.display = 'none';
            return;
          }
          if(!res.ok) throw new Error(await res.text());
          const data = await res.json();
          currentHandle = data.handle;
          userHeading.textContent = `@${data.handle} (${data.account_id})`;
          const items = Array.isArray(data.tags) ? data.tags : [];
          const html = items.length ? items.map(item => `
            <div class="flex ai-c jc-b" style="padding:6px 0; border-bottom:1px solid rgba(185,236,255,.12)">
              <div><span class="badge">#${item.slug}</span> ${item.label || ''}</div>
              <button class="btn btn--ghost" data-tag-id="${item.tag_id}">Remove</button>
            </div>
          `).join('') : '<div class="badge">No tag overrides</div>';
          html += '<div class="hide-sm">Built with <a href="https://windsurf.com/refer?referral_code=4j75hl1x7ibz3yj8" class="link">Windsurf</a> guidelines</div>';
          userTagList.innerHTML = html;
          await loadTags(true);
          assignPanel.style.display = 'block';
          userTagList.querySelectorAll('button[data-tag-id]').forEach(btn => {
            btn.addEventListener('click', async () => {
              const tagId = btn.dataset.tagId;
              try{
                const resDel = await fetch(`/tags/${encodeURIComponent(tagId)}/visibility/users/${encodeURIComponent(currentHandle)}`, {
                  method:'DELETE',
                  headers:{ ...authHeaders() },
                });
                if(!resDel.ok) throw new Error(await resDel.text());
                showToast('Removed tag access', 'ok');
                await loadAssignments(currentHandle);
              }catch(err){
                console.error('remove tag failed', err);
                showToast('Failed to remove tag', 'err');
              }
            });
          });
        }catch(err){
          console.error('loadAssignments failed', err);
          userTagList.innerHTML = '<div class="badge badge--err">Failed to load assignments</div>';
        }
      }

      lookupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideStatus();
        const handle = handleInput.value.trim();
        if(!handle){
          setStatus('Handle is required', 'warn');
          assignPanel.style.display = 'none';
          return;
        }
        await loadAssignments(handle);
      });

      userSearch.addEventListener('input', () => {
        userPage = 0;
        loadUsers();
      });
      btnRefreshUsers.addEventListener('click', () => { loadUsers(); });
      btnPrevPage.addEventListener('click', () => {
        if(userPage === 0) return;
        userPage -= 1;
        loadUsers();
      });
      btnNextPage.addEventListener('click', () => {
        if((userPage + 1) * pageSize >= userTotal) return;
        userPage += 1;
        loadUsers();
      });

      assignForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideAssignStatus();
        if(!currentHandle){
          setAssignStatus('Load a user first', 'warn');
          return;
        }
        const tagId = tagSelect.value;
        if(!tagId){
          setAssignStatus('Select a tag to add', 'warn');
          return;
        }
        try{
          const res = await fetch(`/tags/${encodeURIComponent(tagId)}/visibility/users`, {
            method:'POST',
            headers:{ 'Content-Type':'application/json', ...authHeaders() },
            body: JSON.stringify({ handle: currentHandle })
          });
          if(res.status === 404){
            const msg = await res.text();
            setAssignStatus(msg.includes('User not found') ? 'User not found' : 'Tag not found', 'warn');
            return;
          }
          if(!res.ok) throw new Error(await res.text());
          showToast('Tag assigned', 'ok');
          await loadAssignments(currentHandle);
        }catch(err){
          console.error('assign failed', err);
          setAssignStatus('Failed to assign tag', 'err');
        }
      });

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/auth/logout', { method: 'POST', headers: { ...authHeaders() } });
          } catch (err) {
            console.error('logout failed', err);
          }
          clearToken();
          showToast('Signed out', 'ok');
          window.location.href = '/';
        });
      }

      function updateAuthControls() {
        const hasToken = !!getToken();
        if (loginLink) loginLink.style.display = hasToken ? 'none' : 'inline-flex';
        if (logoutBtn) logoutBtn.style.display = hasToken ? 'inline-flex' : 'none';
      }

          refreshAuthUI();
          updateAuthControls();
          const ok = await checkAdminAccess();
          if(!ok) return;
          await loadTags();
          await loadUsers();
          const initialHandle = handleInput.value.trim();
          if(initialHandle) await loadAssignments(initialHandle);
        })();
      });
    });
  </script>
</body>
</html>
