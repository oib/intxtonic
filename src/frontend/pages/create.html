<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>inTXTonic • New Post</title>
  <link rel="stylesheet" href="/src/frontend/css/base.css">
  <link rel="stylesheet" href="/src/frontend/css/components.css">
  <link rel="stylesheet" href="/src/frontend/css/layout.css">
</head>
<body>
  <header class="site">
    <div class="inner container flex ai-c jc-b">
      <div class="flex ai-c" style="gap:8px">
        <a class="btn btn--subtle" href="/home" data-i18n="nav.home">Home</a>
        <a id="admin-link" class="btn btn--subtle" href="/admin" style="display:none" data-i18n="nav.admin">Admin</a>
      </div>
      <nav class="flex ai-c" style="gap:8px">
        <a id="dashboard-link" class="btn btn--subtle" href="/dashboard/">Dashboard</a>
        <a id="profile-link" class="btn btn--subtle" href="#" style="display:none">Profile</a>
        <a id="login-link" class="btn btn--subtle" href="/login/">Login</a>
        <button id="logout-btn" class="btn btn--ghost" style="display:none">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="row">
      <div class="col-12">
        <div class="card">
          <h1>Create a New Post</h1>
          <p class="mb-6" style="color:var(--tx-1)">Write your post below. Posts are visible to logged-in users.</p>
          <div class="grid" style="gap:12px">
            <label>
              <div class="mb-6">Title</div>
              <input id="title" class="input" placeholder="Post title" required>
            </label>
            <label>
              <div class="mb-6">Content (Markdown)</div>
              <textarea id="body" class="input" rows="12" placeholder="Write your post in Markdown..." maxlength="1200" required></textarea>
              <div class="hint" style="margin-top:6px; color:var(--tx-1)">
                <span id="body-count">0</span>/1200 characters
              </div>
            </label>
            <div class="flex ai-c" style="gap:8px; flex-wrap:wrap">
              <input id="image-file" type="file" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" style="max-width:280px">
              <input id="image-alt" class="input" placeholder="Alt text (optional)" style="max-width:220px">
              <button id="btn-upload-image" class="btn btn--subtle" type="button">Upload image</button>
              <span class="badge" style="color:var(--tx-1)">Up to 5MB; PNG/JPG/GIF/WebP</span>
            </div>
            <div class="divider"></div>
            <div>
              <h2 class="mb-6" style="margin:0">Tags</h2>
              <div style="position:relative;">
                <div class="flex ai-c" style="gap:8px; flex-wrap:wrap">
                  <input id="q-tags-create" class="input" placeholder="Search tags..." style="max-width:260px">
                  <button id="btn-search-tags-create" class="btn btn--subtle" type="button">Search</button>
                </div>
                <div id="tag-suggestions-create" class="card" style="position:absolute; display:none; width:100%; max-width:420px; z-index:20; margin-top:6px;"></div>
              </div>
              <div id="admin-tag-link" style="display:none; margin-top:10px" class="flex ai-c" >
                <a class="btn btn--subtle" href="/admin/tags">Open Tag Management</a>
                <span class="badge" style="margin-left:8px">Tag creation is handled on the admin Tags page.</span>
              </div>
              <div style="margin-top:10px" class="flex ai-c" >
                <div id="selected-tags-create" class="flex" style="gap:6px; flex-wrap:wrap"></div>
                <button id="btn-clear-tags-create" class="btn btn--subtle" type="button" style="display:none; margin-left:8px">Clear</button>
              </div>
            </div>
            <div class="flex" style="gap:8px">
              <button id="btn-publish" class="btn">Publish</button>
              <a href="/home" class="btn btn--subtle">Cancel</a>
            </div>
            <div id="msg" class="badge" style="display:none"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site">
    <div class="inner container flex ai-c jc-b">
      <div> <span id="year"></span> inTXTonic</div>
      <div class="hide-sm">Built with Windsurf guidelines</div>
    </div>
  </footer>

  <script type="module">
    import { authHeaders, getToken, clearToken } from '/src/frontend/js/auth.js';
    import { showToast } from '/src/frontend/js/toast.js';

    document.getElementById('year').textContent = new Date().getFullYear().toString();

    // Strong auth check: prefer /auth/me (cookie or token). Redirect to /login on 401.
    let currentUser = null;
    try {
      const r = await fetch('/auth/me', { headers: { ...authHeaders() } });
      if (!r.ok) { window.location.href = '/login'; }
      else { currentUser = await r.json(); }
    } catch { window.location.href = '/login'; }

    // Header auth UI
    const loginLink = document.getElementById('login-link');
    const logoutBtn = document.getElementById('logout-btn');
    const profileLink = document.getElementById('profile-link');
    const dashboardLink = document.getElementById('dashboard-link');
    const adminLink = document.getElementById('admin-link');

    function refreshAuthUI(){
      const has = !!getToken();
      loginLink.style.display = has ? 'none' : 'inline-flex';
      logoutBtn.style.display = has ? 'inline-flex' : 'none';
      if (dashboardLink) dashboardLink.style.display = has ? 'inline-flex' : 'none';
      if (profileLink) {
        const defaultLabel = profileLink.dataset.defaultLabel || profileLink.textContent || 'Profile';
        profileLink.dataset.defaultLabel = defaultLabel;
        profileLink.textContent = defaultLabel;
        profileLink.style.display = 'none';
      }
      if (has) {
        const u = currentUser;
        if (u && u.handle && profileLink) {
          profileLink.href = `/user/${encodeURIComponent(u.handle)}`;
          const label = (u.display_name || u.handle || '').trim();
          if (label) profileLink.textContent = label;
          profileLink.style.display = 'inline-flex';
        }
        const adminTagLink = document.getElementById('admin-tag-link');
        if (u && (u.is_admin || (Array.isArray(u.roles) && u.roles.includes('admin')))) {
          if (adminLink) adminLink.style.display = 'inline-flex';
          if (adminTagLink) adminTagLink.style.display = 'flex';
        } else {
          if (adminLink) adminLink.style.display = 'none';
          if (adminTagLink) adminTagLink.style.display = 'none';
        }
      }
    }
    refreshAuthUI();
    logoutBtn.addEventListener('click', async () => {
      try { await fetch('/auth/logout', { method: 'POST', headers: { ...authHeaders() } }); } catch {}
      clearToken();
      showToast('Signed out','ok');
      window.location.href = '/';
    });

    function makeSlug(label){
      return (label || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9-_.]+/g, '-')
        .replace(/-{2,}/g, '-')
        .replace(/^[-.]+|[-.]+$/g, '');
    }

    // Tag selection state
    const selectedTags = new Map();
    function renderSelectedTags(){
      const el = document.getElementById('selected-tags-create');
      const btnClear = document.getElementById('btn-clear-tags-create');
      const arr = Array.from(selectedTags.values());
      if (btnClear) btnClear.style.display = arr.length ? 'inline-flex' : 'none';
      el.innerHTML = arr.length ? arr.map(({ slug }) => `<span class="badge" data-tag-slug="${slug}">#${slug} <button class="btn btn--ghost rm-tag" data-slug="${slug}">×</button></span>`).join(' ') : '<span class="badge">No tags selected</span>';
      el.querySelectorAll('button.rm-tag').forEach(b => b.addEventListener('click', () => {
        const slug = b.getAttribute('data-slug');
        if (slug) selectedTags.delete(slug);
        renderSelectedTags();
      }));
    }
    renderSelectedTags();

    // Tag search/suggestions
    const elQTags = document.getElementById('q-tags-create');
    const elBtnSearchTags = document.getElementById('btn-search-tags-create');
    const elSug = document.getElementById('tag-suggestions-create');
    let sugItems = [];
    let sugIndex = -1;
    let tmrSug;
    function renderTagSuggestions(items){
      // De-duplicate by slug
      const seen = new Set();
      sugItems = (items||[]).filter(t => { if(seen.has(t.slug)) return false; seen.add(t.slug); return true; });
      if(!sugItems.length){ elSug.style.display='none'; return; }
      elSug.innerHTML = sugItems.map((t,i) => `
        <div class="sug-row" data-idx="${i}" data-slug="${t.slug}" style="padding:8px; cursor:pointer;">
          <span>#${t.slug}</span>
          ${t.label && t.label !== t.slug ? ` <span style=\"color:var(--tx-1)\">— ${t.label}</span>` : ''}
        </div>
      `).join('');
      elSug.style.display = 'block';
      sugIndex = -1;
      elSug.querySelectorAll('.sug-row').forEach(row => {
        row.addEventListener('mouseenter', () => highlightSuggestion(parseInt(row.getAttribute('data-idx'))));
        row.addEventListener('click', () => selectSuggestion(parseInt(row.getAttribute('data-idx'))));
      });
    }
    function highlightSuggestion(idx){
      const rows = elSug.querySelectorAll('.sug-row');
      rows.forEach(r => r.style.background='transparent');
      if(idx>=0 && idx<rows.length){ rows[idx].style.background = 'var(--bg-3)'; }
      sugIndex = idx;
    }
    function selectSuggestion(idx){
      if(idx<0 || idx>=sugItems.length) return;
      const slug = sugItems[idx].slug;
      if(slug){
        const label = sugItems[idx].label || slug;
        selectedTags.set(slug, { slug, label });
        renderSelectedTags();
      }
      if(elQTags) elQTags.value = '';
      elSug.style.display='none';
    }
    async function searchTags(q){
      try {
        const res = await fetch(`/tags?query=${encodeURIComponent(q)}&limit=10`, { headers:{ ...authHeaders() } });
        if(!res.ok){ elSug.style.display='none'; return; }
        const rows = await res.json();
        renderTagSuggestions(rows);
      } catch { elSug.style.display='none'; }
    }
    elBtnSearchTags?.addEventListener('click', () => { const q = (elQTags?.value||'').trim(); if(q) searchTags(q); });
    elQTags?.addEventListener('input', () => {
      const q = (elQTags?.value || '').trim();
      clearTimeout(tmrSug);
      if(!q){ elSug.style.display='none'; return; }
      tmrSug = setTimeout(() => searchTags(q), 200);
    });
    elQTags?.addEventListener('blur', () => setTimeout(() => { elSug.style.display='none'; }, 150));
    document.getElementById('btn-clear-tags-create')?.addEventListener('click', () => { selectedTags.clear(); renderSelectedTags(); });
    elQTags?.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        if (elSug.style.display === 'block' && sugItems.length){
          selectSuggestion(sugIndex>=0 ? sugIndex : 0);
          e.preventDefault();
          return;
        }
        const raw = (elQTags?.value || '').trim();
        if(!raw) return;
        const slug = makeSlug(raw);
        if(!slug){ showToast('Invalid tag', 'warn'); return; }
        selectedTags.set(slug, { slug, label: raw });
        renderSelectedTags();
        elQTags.value = '';
        elSug.style.display = 'none';
        e.preventDefault();
      }
      if(e.key==='ArrowDown'){
        if (elSug.style.display==='block' && sugItems.length){ highlightSuggestion(Math.min((sugIndex<0?0:sugIndex+1), sugItems.length-1)); e.preventDefault(); }
      } else if (e.key==='ArrowUp'){
        if (elSug.style.display==='block' && sugItems.length){ highlightSuggestion(Math.max((sugIndex<=0?0:sugIndex-1), 0)); e.preventDefault(); }
      }
    });
    // ensure default enter handler above doesn't double bind
    // (the search on enter when suggestions hidden handled there)

    // Admin: create tag
    // Publish handler
    const elTitle = document.getElementById('title');
    const elBody = document.getElementById('body');
    const elBtnPublish = document.getElementById('btn-publish');
    const elBodyCount = document.getElementById('body-count');
    const BODY_LIMIT = 1200;

    function updateBodyCount(){
      const value = elBody.value || '';
      const length = value.length;
      if (elBodyCount) elBodyCount.textContent = length.toString();
      if (length > BODY_LIMIT){
        elBody.value = value.slice(0, BODY_LIMIT);
        if (elBodyCount) elBodyCount.textContent = BODY_LIMIT.toString();
      }
    }
    updateBodyCount();
    elBody.addEventListener('input', updateBodyCount);
    const elMsg = document.getElementById('msg');

    // Image upload handler -> inserts markdown at cursor
    function insertAtCursor(textarea, snippet){
      const start = textarea.selectionStart || 0;
      const end = textarea.selectionEnd || 0;
      const before = textarea.value.slice(0, start);
      const after = textarea.value.slice(end);
      textarea.value = before + snippet + after;
      const pos = start + snippet.length;
      textarea.selectionStart = textarea.selectionEnd = pos;
      textarea.focus();
    }
    document.getElementById('btn-upload-image')?.addEventListener('click', async () => {
      const fileInput = document.getElementById('image-file');
      const altInput = document.getElementById('image-alt');
      const file = fileInput?.files?.[0];
      if(!file){ showToast('Choose an image first','warn'); return; }
      if(file.size > 5*1024*1024){ showToast('Image too large (max 5MB)','warn'); return; }
      const fd = new FormData();
      fd.append('file', file);
      try{
        const res = await fetch('/uploads', { method:'POST', headers: { ...authHeaders() }, body: fd });
        if(!res.ok){
          const txt = await res.text();
          showToast(txt || 'Upload failed', 'err');
          return;
        }
        const data = await res.json();
        if(data?.url){
          const alt = (altInput?.value || '').trim();
          const md = `\n\n![${alt}](${data.url})\n\n`;
          insertAtCursor(elBody, md);
          showToast('Image uploaded','ok');
          // Clear file input
          if(fileInput) fileInput.value = '';
          if(altInput) altInput.value = '';
        } else {
          showToast('Upload failed','err');
        }
      }catch(err){ showToast('Upload failed','err'); }
    });

    elBtnPublish.addEventListener('click', async () => {
      const title = (elTitle.value || '').trim();
      const body_md = (elBody.value || '').trim();
      elMsg.style.display = 'none';
      if (!title || !body_md) { showToast('Title and body required','warn'); return; }
      if (body_md.length > BODY_LIMIT) { showToast('Post body too long (max 600 characters)','warn'); return; }
      try {
        const res = await fetch('/posts', { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeaders() }, body: JSON.stringify({ title, body_md }) });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        showToast('Post published','ok');
        if (data?.id) {
          // Attach selected tags (if any)
          const arr = Array.from(selectedTags.values() || []);
          for (const tag of arr) {
            try {
              await fetch(`/posts/${data.id}/tags`, { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeaders() }, body: JSON.stringify({ slug: tag.slug, label: tag.label }) });
            } catch {}
          }
          window.location.href = `/post/${data.id}`; return;
        }
        elMsg.textContent = 'Published, but missing id in response';
        elMsg.style.display = 'inline-block';
      } catch (err) {
        elMsg.textContent = 'Publish failed';
        elMsg.style.display = 'inline-block';
        showToast('Publish failed','err');
      }
    });
  </script>
</body>
</html>
