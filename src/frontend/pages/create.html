<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>inTXTonic • New Post</title>
  <!-- Inline critical preloader styles to prevent FOUC -->
  <style>
    /* Prevent FOUC - hide everything until preloader is ready */
    html { visibility: hidden !important; }
    body:not(.preloader-ready) { visibility: hidden !important; }
    .preloader {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      background: #ffffff !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 9999 !important;
      transition: opacity 0.3s ease-out !important;
      visibility: visible !important;
    }
    .preloader--hidden {
      opacity: 0 !important;
      pointer-events: none !important;
    }
    .preloader__content {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      gap: 1rem !important;
    }
    .preloader__spinner {
      width: 40px !important;
      height: 40px !important;
      border: 3px solid #e5e7eb !important;
      border-top: 3px solid #ff7a1a !important;
      border-radius: 50% !important;
      animation: spin 1s linear infinite !important;
    }
    .preloader__text {
      font-size: 0.9rem !important;
      color: #6b7280 !important;
      font-weight: 500 !important;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    body.preloader-ready {
      visibility: visible !important;
    }
    body.preloader-ready .preloader {
      opacity: 1 !important;
    }
    body.styles-loaded {
      visibility: visible !important;
    }
    body.styles-loaded .preloader {
      opacity: 0 !important;
      pointer-events: none !important;
    }
    /* Fix h1 elements */
    h1 { font-size: 1.75rem !important; margin: 0 0 0.5rem 0 !important; }
  </style>
  <link rel="stylesheet" href="/src/frontend/css/base.css">
  <link rel="stylesheet" href="/src/frontend/css/components.css">
  <link rel="stylesheet" href="/src/frontend/css/layout.css">
  <link rel="stylesheet" href="/src/frontend/css/components/preloader.css">
  <link rel="stylesheet" href="/src/frontend/css/pages/create.css">
  <script type="module" src="/src/frontend/js/preloader.js"></script>
  <script type="module" src="/src/frontend/js/i18n-runtime.js" data-i18n-init></script>
  <style>
    .tag-domain-admin { background: var(--accent-1); color: var(--accent); border: 1px solid var(--accent); }
    .tag-domain-user_handle { background: var(--bg-2); color: var(--tx-1); border: 1px solid var(--border-color); }
    .tag-domain-language { background: var(--success-1); color: var(--success); border: 1px solid var(--success); }
    .tag-domain-user_created { background: var(--bg-1); color: var(--tx-1); border: 1px solid var(--border-color); }
  </style>
</head>
<body>
  <header class="site">
    <div class="inner container flex ai-c jc-b">
      <a class="btn btn--subtle" href="/home" data-i18n="nav.home">Home</a>
      <nav class="flex ai-c" style="gap:8px">
        <button id="logout-btn" class="btn btn--ghost" style="display:none">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="row">
      <div class="col-12">
        <div class="card">
          <h1>Create a New Post</h1>
          <p class="mb-6" style="color:var(--tx-1)">Write your post below. Posts are visible to logged-in users.</p>
          <div class="grid" style="gap:12px">
            <label>
              <div class="mb-6">Title</div>
              <input id="title" class="input" placeholder="Post title" required>
            </label>
            <label>
              <div class="mb-6">Content (Markdown)</div>
              <textarea id="body" class="input" rows="12" placeholder="Write your post in Markdown..." maxlength="1200" required></textarea>
              <div class="hint" style="margin-top:6px; color:var(--tx-1)">
                <span id="body-count">0</span>/1200 characters
              </div>
            </label>
            <div class="flex ai-c" style="gap:8px; flex-wrap:wrap">
              <input id="image-file" type="file" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" style="max-width:280px">
              <input id="image-alt" class="input" placeholder="Alt text (optional)" style="max-width:220px">
              <button id="btn-upload-image" class="btn btn--subtle" type="button">Upload image</button>
              <span class="badge" style="color:var(--tx-1)">Up to 5MB; PNG/JPG/GIF/WebP</span>
            </div>
            <div class="divider"></div>
            <div>
              <h2 class="mb-6" style="margin:0">Tags</h2>
              <div style="position:relative;">
                <div class="flex ai-c" style="gap:8px; flex-wrap:wrap">
                  <input id="q-tags-create" class="input" placeholder="Add or search tags..." style="max-width:300px">
                  <button id="btn-add-tag-create" class="btn btn--subtle" type="button">Add</button>
                </div>
                <div id="tag-suggestions-create" class="card" style="position:absolute; display:none; width:100%; max-width:420px; z-index:20; margin-top:6px;"></div>
              </div>
              <div id="admin-tag-link" style="display:none; margin-top:10px" class="flex ai-c" >
                <a class="btn btn--subtle" href="/admin/tags">Open Tag Management</a>
                <span class="badge" style="margin-left:8px">Tag creation is handled on the admin Tags page.</span>
              </div>
              <div style="margin-top:10px" class="flex ai-c" >
                <div id="selected-tags-create" class="flex" style="gap:6px; flex-wrap:wrap"></div>
                <button id="btn-clear-tags-create" class="btn btn--subtle" type="button" style="display:none; margin-left:8px">Clear</button>
              </div>
            </div>
            <div class="flex" style="gap:8px">
              <button id="btn-publish" class="btn">Publish</button>
              <a href="/home" class="btn btn--subtle">Cancel</a>
            </div>
            <div id="msg" class="badge" style="display:none"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site">
    <div class="inner container flex ai-c jc-b">
      <div>&copy; <a href="https://bubuit.net/" class="link">bubuit.net</a></div>
      <div class="hide-sm">Built with <a href="https://windsurf.com/refer?referral_code=4j75hl1x7ibz3yj8" class="link">Windsurf</a> guidelines</div>
    </div>
  </footer>

  <script type="module">
    import { authHeaders, getToken, clearToken } from '/src/frontend/js/auth.js';
    import { showToast } from '/src/frontend/js/toast.js';
    import preloader from '/src/frontend/js/preloader.js';

    // Initialize preloader
    preloader.init();

    // Strong auth check: prefer /auth/me (cookie or token). Redirect to /login on 401.
    let currentUser = null;
    try {
      const r = await fetch('/auth/me', { headers: { ...authHeaders() } });
      if (!r.ok) { window.location.href = '/login'; }
      else { currentUser = await r.json(); }
    } catch { window.location.href = '/login'; }

    // Header auth UI
    const logoutBtn = document.getElementById('logout-btn');
    const adminTagLink = document.getElementById('admin-tag-link');

    function refreshAuthUI(){
      const has = !!getToken();
      if (logoutBtn) logoutBtn.style.display = has ? 'inline-flex' : 'none';
      if (adminTagLink) {
        const u = currentUser;
        const isAdmin = u && (u.is_admin || (Array.isArray(u.roles) && u.roles.includes('admin')));
        adminTagLink.style.display = isAdmin ? 'flex' : 'none';
      }
    }
    refreshAuthUI();
    logoutBtn.addEventListener('click', async () => {
      try { await fetch('/auth/logout', { method: 'POST', headers: { ...authHeaders() } }); } catch {}
      clearToken();
      showToast('Signed out','ok');
      window.location.href = '/';
    });

    function makeSlug(label){
      return (label || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9-_.]+/g, '-')
        .replace(/-{2,}/g, '-')
        .replace(/^[-.]+|[-.]+$/g, '');
    }

    // Language name mapping
    const LANGUAGE_NAMES = {
      'en': 'English',
      'de': 'German',
      'fr': 'French',
      'es': 'Spanish',
      'it': 'Italian',
      'pt': 'Portuguese',
      'nl': 'Dutch',
      'pl': 'Polish',
      'ru': 'Russian',
      'ja': 'Japanese',
      'ko': 'Korean',
      'zh': 'Chinese',
      'ar': 'Arabic',
      'hi': 'Hindi',
      'tr': 'Turkish',
      'sv': 'Swedish',
      'no': 'Norwegian',
      'da': 'Danish',
      'fi': 'Finnish',
      'cs': 'Czech',
      'sk': 'Slovak',
      'hu': 'Hungarian',
      'ro': 'Romanian',
      'bg': 'Bulgarian',
      'hr': 'Croatian',
      'sr': 'Serbian',
      'sl': 'Slovenian',
      'et': 'Estonian',
      'lv': 'Latvian',
      'lt': 'Lithuanian',
      'el': 'Greek',
      'he': 'Hebrew',
      'th': 'Thai',
      'vi': 'Vietnamese',
      'uk': 'Ukrainian',
      'be': 'Belarusian',
      'mk': 'Macedonian',
      'sq': 'Albanian',
      'mt': 'Maltese',
      'is': 'Icelandic',
      'ga': 'Irish',
      'cy': 'Welsh',
      'eu': 'Basque',
      'ca': 'Catalan'
    };

    // Tag selection state
    const selectedTags = new Map();
    function renderSelectedTags(){
      const el = document.getElementById('selected-tags-create');
      const btnClear = document.getElementById('btn-clear-tags-create');
      const arr = Array.from(selectedTags.values());
      if (btnClear) btnClear.style.display = arr.length ? 'inline-flex' : 'none';
      el.innerHTML = arr.length ? arr.map(({ slug, label, domain }) => {
        const isRemovable = domain !== 'admin' && domain !== 'user_handle' && domain !== 'language';
        const removeBtn = isRemovable ? `<button class="btn btn--ghost rm-tag" data-slug="${slug}">×</button>` : '';
        const domainClass = domain ? `tag-domain-${domain}` : '';
        const domainHint = domain && domain !== 'user_created' ? ` <span style="color:var(--tx-2); font-size:0.8em">[${domain}]</span>` : '';
        return `<span class="badge ${domainClass}" data-tag-slug="${slug}" title="${domain || 'user_created'}">#${slug} ${label && label !== slug ? `(${label})` : ''}${domainHint} ${removeBtn}</span>`;
      }).join(' ') : '<span class="badge">No tags selected</span>';
      el.querySelectorAll('button.rm-tag').forEach(b => b.addEventListener('click', () => {
        const slug = b.getAttribute('data-slug');
        if (slug) selectedTags.delete(slug);
        renderSelectedTags();
      }));
    }

    // Auto-add user's default language tag
    function addLanguageTag(locale) {
      if (!locale || locale === 'en') return; // Skip English as it's the default
      const langName = LANGUAGE_NAMES[locale] || locale.toUpperCase();
      selectedTags.set(locale, { slug: locale, label: langName, domain: 'language' });
    }
    
    // Auto-add user handle tag
    function addUserHandleTag(handle) {
      if (!handle) return;
      const slug = makeSlug(handle);
      if (slug) {
        selectedTags.set(slug, { slug, label: handle, domain: 'user_handle' });
      }
    }

    // Initialize with user's language tag and handle tag
    if (currentUser && currentUser.locale) {
      addLanguageTag(currentUser.locale);
    }
    if (currentUser && currentUser.handle) {
      addUserHandleTag(currentUser.handle);
    }
    renderSelectedTags();

    // Tag search/suggestions
    const elQTags = document.getElementById('q-tags-create');
    const elBtnSearchTags = document.getElementById('btn-search-tags-create');
    const elSug = document.getElementById('tag-suggestions-create');
    let sugItems = [];
    let sugIndex = -1;
    let tmrSug;
    function renderTagSuggestions(items, query){
      // De-duplicate by slug
      const seen = new Set();
      sugItems = (items||[]).filter(t => { if(seen.has(t.slug)) return false; seen.add(t.slug); return true; });
      
      let html = '';
      
      // Show existing tags that match
      if(sugItems.length){
        html += sugItems.map((t,i) => `
          <div class="sug-row" data-idx="${i}" data-slug="${t.slug}" style="padding:8px; cursor:pointer; border-bottom:1px solid var(--border-color)">
            <span>#${t.slug}</span>
            ${t.label && t.label !== t.slug ? ` <span style="color:var(--tx-1)">— ${t.label}</span>` : ''}
          </div>
        `).join('');
      }
      
      // Show option to create new tag if query doesn't match existing
      if(query && !sugItems.some(t => t.slug === makeSlug(query))){
        const slug = makeSlug(query);
        if(slug && !selectedTags.has(slug)){
          const createIdx = sugItems.length;
          html += `
            <div class="sug-row sug-create" data-idx="${createIdx}" data-slug="${slug}" data-label="${query}" style="padding:8px; cursor:pointer; background:var(--bg-2)">
              <span style="color:var(--accent)">+ Create new tag: #${slug}</span>
              <span style="color:var(--tx-1)"> — "${query}"</span>
            </div>
          `;
          // Store the create option in sugItems for selection
          sugItems.push({ slug, label: query, isCreate: true });
        }
      }
      
      if(!html){ 
        elSug.style.display='none'; 
        return; 
      }
      
      elSug.innerHTML = html;
      elSug.style.display = 'block';
      sugIndex = -1;
      elSug.querySelectorAll('.sug-row').forEach(row => {
        row.addEventListener('mouseenter', () => highlightSuggestion(parseInt(row.getAttribute('data-idx'))));
        row.addEventListener('click', () => selectSuggestion(parseInt(row.getAttribute('data-idx'))));
      });
    }
    function highlightSuggestion(idx){
      const rows = elSug.querySelectorAll('.sug-row');
      rows.forEach(r => r.style.background='transparent');
      if(idx>=0 && idx<rows.length){ rows[idx].style.background = 'var(--bg-3)'; }
      sugIndex = idx;
    }
    function selectSuggestion(idx){
      if(idx<0 || idx>=sugItems.length) return;
      const item = sugItems[idx];
      const slug = item.slug;
      if(slug && !selectedTags.has(slug)){
        const label = item.label || slug;
        const domain = item.isCreate ? 'user_created' : (item.domain || 'user_created');
        selectedTags.set(slug, { slug, label, domain });
        renderSelectedTags();
      }
      if(elQTags) elQTags.value = '';
      elSug.style.display='none';
    }
    async function searchTags(q){
      try {
        const res = await fetch(`/tags?query=${encodeURIComponent(q)}&limit=10`, { headers:{ ...authHeaders() } });
        if(!res.ok){ elSug.style.display='none'; return; }
        const rows = await res.json();
        renderTagSuggestions(rows, q);
      } catch { elSug.style.display='none'; }
    }
    
    // Add tag button handler
    const elBtnAddTag = document.getElementById('btn-add-tag-create');
    function addCurrentTag(){
      const raw = (elQTags?.value || '').trim();
      if(!raw){ showToast('Enter a tag name', 'warn'); return; }
      const slug = makeSlug(raw);
      if(!slug){ showToast('Invalid tag', 'warn'); return; }
      if(selectedTags.has(slug)){ showToast('Tag already added', 'warn'); return; }
      selectedTags.set(slug, { slug, label: raw, domain: 'user_created' });
      renderSelectedTags();
      if(elQTags) elQTags.value = '';
      elSug.style.display='none';
    }
    
    elBtnAddTag?.addEventListener('click', addCurrentTag);
    elBtnSearchTags?.addEventListener('click', () => { const q = (elQTags?.value||'').trim(); if(q) searchTags(q); });
    elQTags?.addEventListener('input', () => {
      const q = (elQTags?.value || '').trim();
      clearTimeout(tmrSug);
      if(!q){ elSug.style.display='none'; return; }
      tmrSug = setTimeout(() => searchTags(q), 200);
    });
    elQTags?.addEventListener('blur', () => setTimeout(() => { elSug.style.display='none'; }, 150));
    document.getElementById('btn-clear-tags-create')?.addEventListener('click', () => { selectedTags.clear(); renderSelectedTags(); });
    elQTags?.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        if (elSug.style.display === 'block' && sugItems.length){
          selectSuggestion(sugIndex>=0 ? sugIndex : 0);
          e.preventDefault();
          return;
        }
        addCurrentTag();
        e.preventDefault();
      }
      if(e.key==='ArrowDown'){
        if (elSug.style.display==='block' && sugItems.length){ highlightSuggestion(Math.min((sugIndex<0?0:sugIndex+1), sugItems.length-1)); e.preventDefault(); }
      } else if (e.key==='ArrowUp'){
        if (elSug.style.display==='block' && sugItems.length){ highlightSuggestion(Math.max((sugIndex<=0?0:sugIndex-1), 0)); e.preventDefault(); }
      }
    });
    // ensure default enter handler above doesn't double bind
    // (the search on enter when suggestions hidden handled there)

    // Admin: create tag
    // Publish handler
    const elTitle = document.getElementById('title');
    const elBody = document.getElementById('body');
    const elBtnPublish = document.getElementById('btn-publish');
    const elBodyCount = document.getElementById('body-count');
    const BODY_LIMIT = 1200;

    function updateBodyCount(){
      const value = elBody.value || '';
      const length = value.length;
      if (elBodyCount) elBodyCount.textContent = length.toString();
      if (length > BODY_LIMIT){
        elBody.value = value.slice(0, BODY_LIMIT);
        if (elBodyCount) elBodyCount.textContent = BODY_LIMIT.toString();
      }
    }
    updateBodyCount();
    elBody.addEventListener('input', updateBodyCount);
    const elMsg = document.getElementById('msg');

    // Image upload handler -> inserts markdown at cursor
    function insertAtCursor(textarea, snippet){
      const start = textarea.selectionStart || 0;
      const end = textarea.selectionEnd || 0;
      const before = textarea.value.slice(0, start);
      const after = textarea.value.slice(end);
      textarea.value = before + snippet + after;
      const pos = start + snippet.length;
      textarea.selectionStart = textarea.selectionEnd = pos;
      textarea.focus();
    }
    document.getElementById('btn-upload-image')?.addEventListener('click', async () => {
      const fileInput = document.getElementById('image-file');
      const altInput = document.getElementById('image-alt');
      const file = fileInput?.files?.[0];
      if(!file){ showToast('Choose an image first','warn'); return; }
      if(file.size > 5*1024*1024){ showToast('Image too large (max 5MB)','warn'); return; }
      const fd = new FormData();
      fd.append('file', file);
      try{
        const res = await fetch('/uploads', { method:'POST', headers: { ...authHeaders() }, body: fd });
        if(!res.ok){
          const txt = await res.text();
          showToast(txt || 'Upload failed', 'err');
          return;
        }
        const data = await res.json();
        if(data?.url){
          const alt = (altInput?.value || '').trim();
          const md = `\n\n![${alt}](${data.url})\n\n`;
          insertAtCursor(elBody, md);
          showToast('Image uploaded','ok');
          // Clear file input
          if(fileInput) fileInput.value = '';
          if(altInput) altInput.value = '';
        } else {
          showToast('Upload failed','err');
        }
      }catch(err){ showToast('Upload failed','err'); }
    });

    elBtnPublish.addEventListener('click', async () => {
      const title = (elTitle.value || '').trim();
      const body_md = (elBody.value || '').trim();
      elMsg.style.display = 'none';
      if (!title || !body_md) { showToast('Title and body required','warn'); return; }
      if (body_md.length > BODY_LIMIT) { showToast('Post body too long (max 600 characters)','warn'); return; }
      try {
        const res = await fetch('/posts', { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeaders() }, body: JSON.stringify({ title, body_md }) });
        if (res.status === 401) {
          clearToken();
          showToast('Please sign in to publish posts','warn');
          window.location.href = '/login';
          return;
        }
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        showToast('Post published','ok');
        if (data?.id) {
          // Attach selected tags (if any)
          const arr = Array.from(selectedTags.values() || []);
          for (const tag of arr) {
            try {
              await fetch(`/posts/${data.id}/tags`, { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeaders() }, body: JSON.stringify({ slug: tag.slug, label: tag.label }) });
            } catch {}
          }
          window.location.href = `/post/${data.id}`; return;
        }
        elMsg.textContent = 'Published, but missing id in response';
        elMsg.style.display = 'inline-block';
      } catch (err) {
        elMsg.textContent = 'Publish failed';
        elMsg.style.display = 'inline-block';
        showToast('Publish failed','err');
      }
    });
  </script>
  <!-- Inline preloader initialization - runs after body is available -->
  <script>
    // Initialize preloader immediately after body is parsed
    function initPreloader() {
      if (document.body) {
        // Show preloader and make content visible
        document.documentElement.style.visibility = 'visible';
        document.body.classList.add('preloader-ready');
      } else {
        // Fallback if body is still not available
        document.addEventListener('DOMContentLoaded', function() {
          document.documentElement.style.visibility = 'visible';
          document.body.classList.add('preloader-ready');
        });
      }
    }
    
    // Run immediately
    initPreloader();
  </script>
</body>
</html>
