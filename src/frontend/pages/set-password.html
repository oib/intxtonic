<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>inTXTonic â€¢ Set Password</title>
  <link rel="stylesheet" href="/src/frontend/css/base.css">
  <link rel="stylesheet" href="/src/frontend/css/components.css">
  <link rel="stylesheet" href="/src/frontend/css/layout.css">
  <style>
    main { min-height: 100dvh; display: grid; place-items: center; padding: 16px; }
    .card { max-width: 460px; width: 100%; }
  </style>
  <script type="module" src="/src/frontend/js/i18n-runtime.js" data-i18n-init></script>
</head>
<body>
  <main class="container">
    <section class="card">
      <h1 style="margin-top:0">Set your password</h1>
      <p class="hint">You are signed in via magic link. Create a password to enable regular login.</p>
      <form id="set-pass-form" class="grid" style="gap:12px">
        <label>
          <div class="mb-6">New password</div>
          <input id="new-pass" class="input" type="password" minlength="8" autocomplete="new-password" required>
        </label>
        <label>
          <div class="mb-6">Confirm password</div>
          <input id="new-pass-2" class="input" type="password" minlength="8" autocomplete="new-password" required>
        </label>
        <button class="btn" type="submit">Save password</button>
        <div id="msg" class="badge" style="display:none"></div>
      </form>
      <div class="hint" style="margin-top:12px">You can skip this and set it later in Settings.</div>
      <div class="flex" style="gap:8px; margin-top:8px">
        <a class="btn btn--subtle" href="/home">Skip for now</a>
      </div>
    </section>
  </main>

  <script type="module">
    import { authHeaders } from '/src/frontend/js/auth.js';
    import { showToast } from '/src/frontend/js/toast.js';

    const form = document.getElementById('set-pass-form');
    const msg = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.style.display = 'none';
      const p1 = document.getElementById('new-pass').value;
      const p2 = document.getElementById('new-pass-2').value;
      if (p1 !== p2) {
        msg.textContent = 'Passwords do not match';
        msg.className = 'badge badge--warn';
        msg.style.display = 'inline-block';
        return;
      }
      if ((p1 || '').length < 8) {
        msg.textContent = 'Password must be at least 8 characters';
        msg.className = 'badge badge--warn';
        msg.style.display = 'inline-block';
        return;
      }
      try {
        const res = await fetch('/users/me/password', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ current_password: null, new_password: p1 }),
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || 'Failed to set password');
        }
        showToast('Password set', 'ok');
        window.location.href = '/home';
      } catch (err) {
        console.error('Set password failed', err);
        msg.textContent = 'Failed to set password. Open Settings to try again later.';
        msg.className = 'badge badge--err';
        msg.style.display = 'inline-block';
        showToast('Unable to set password', 'err');
      }
    });
  </script>
</body>
</html>
