# i18n Documentation for LangSum

## Overview
The i18n system in LangSum supports multilingual features, allowing the application to adapt to different languages. This document focuses on the admin i18n page and its translation tools, which were recently enhanced for better usability and debugging.

## Admin i18n Page (/admin/i18n)
- **Purpose**: Provides an interface for administrators to manage translations, import missing keys, and perform batch or per-key translations using an AI backend.
- **Key Features**:
  - Locale selector for choosing target languages (e.g., all 28 EU languages).
  - Import missing keys button to pull untranslated keys from English.
  - Batch Translate button for translating multiple keys sequentially with progress tracking and cancel option.
  - Per-key Translate button for individual key translation with immediate UI feedback.
  - Debug panel (toggleable) to log AI translation details, including prompts, sources, and destinations.
- **UI Components**:
  - Uses HTML elements like `select`, `progress`, and custom JavaScript for dynamic updates.
  - Flash effect on translated keys for visual feedback.
  - Event listeners handle save, translate, and cancel actions.

## Translation Tool Mechanics
- **Frontend (src/frontend/pages/admin-i18n.html)**:
  - Calls backend endpoint `/i18n-admin/translate-key` for each key translation.
  - Handles asynchronous requests with `async/await`, updating the UI row-by-row or in batch mode.
  - Debug logs capture and display the full AI prompt, source, and destination for each translation.
- **Backend (src/backend/app/api/i18n_admin.py)**:
  - Endpoint `POST /i18n-admin/translate-key`:
    - Accepts `{lang, key}` and uses AI service to translate from English.
    - Masks placeholders (e.g., {name}) to preserve them, translates, then unmasks.
    - Retries if output matches source, with stricter rules (e.g., use localized forms).
    - Trims unintended punctuation and returns `{ok, key, src, dst, prompt, retry_prompt}` for debugging.
  - Relies on `ai_service.py` for AI calls, with enhanced prompts to ensure accurate translations.

## Recent Enhancements
- Added per-key and batch translation with AI integration.
- Improved debug visibility to include prompts and retry attempts.
- Ensured dynamic UI updates without full page reloads for better user experience.

## UI Inventory (/admin/i18n)
- **Header**
  - `a.btn.btn--subtle[href="/admin"]`: Back to Admin
  - `a#login-link.btn.btn--subtle[data-i18n="nav.login"]`: Login link
  - `button#logout-btn.btn.btn--ghost[data-i18n="nav.logout"]`: Logout button (shown if authenticated)

- **Toolbar card** inside `section.row > .card` in `src/frontend/pages/admin-i18n.html`
  - `h1[data-i18n="admin.i18n"]`: Page title
  - `label` with:
    - `span[data-i18n="settings.locale_label"]`: "Default language"
    - `select#locale.input`: Locale picker (pre-seeded with EU languages; also auto-augments from backend `GET /i18n-admin/locales`)
  - `button#btn-import.btn.btn--subtle`: Import Missing (copies keys from EN if absent)
  - `button#btn-translate.btn.btn--subtle`: Batch Translate (AI per missing/EN-identical key)
  - `button#btn-cancel-translate.btn.btn--ghost`: Cancel (shown while batch translating)
  - `progress#translate-progress`: Visual progress bar
  - `span#translate-status`: Live status text
  - `label > input#debug-toggle[type=checkbox]`: Toggle debug mode
  - `button#btn-clear-debug.btn.btn--ghost`: Clear Logs (visible when debug is on)

- **Debug panel** (visible when enabled)
  - `div#debug-panel.card`
  - `span#debug-meta`: Event counter
  - `div#debug-log`: Rolling log of AI prompt/src/dst or errors
  - Server-Sent Events: subscribes to `/notify/events` and displays payloads of type `i18n_debug`

- **Keys card**
  - `h2`: Keys
  - `input#q.input[placeholder="Filter keys..."]`: Client-side filter
  - `div#table.grid`: Rendered rows; each row contains:
    - `code`: i18n key
    - `input.input.kv[data-key]`: editable value field
    - `button.save.btn.btn--subtle[data-key]`: Save (PATCH key)
    - `button.translate.btn.btn--ghost[data-key][data-i18n="post.translate"]`: Per-key AI translate

## Backend API (FastAPI)
Defined in `src/backend/app/api/i18n_admin.py` and mounted in `src/backend/app/main.py`.

- **Auth/Role requirements**
  - All endpoints depend on `require_admin_or_mod` which allows roles `admin` or `moderator`.
  - Mutations require CSRF validation via `csrf_validate`.

- **Endpoints** (`prefix=/i18n-admin`)
  - `GET /locales`
    - Returns discovered locale files under `i18n/*.json` as `[{ code }]`.
  - `GET /keys?lang=XX`
    - Returns the key/value map for the requested language JSON.
  - `PATCH /keys?lang=XX&key=K&value=V`
    - Upserts a single key/value in `i18n/XX.json`. Returns `{ ok: true }`.
  - `POST /import-missing?lang=XX`
    - Copies any missing keys from `en.json` into `XX.json`. Returns `{ ok, added }`.
  - `POST /translate-key` with JSON body `{ lang, key }`
    - Translates the English value for `key` into `lang` using AI.
    - Preserves placeholders like `{name}` via mask/unmask.
    - Heuristic retry if output equals source; trims trailing punctuation if EN had none.
    - Writes to `i18n/XX.json`. Returns `{ ok, key, src, dst, prompt?, retry_prompt? }`.

- **Serving static locales**
  - `app.mount("/i18n", StaticFiles(directory="i18n"))` in `src/backend/app/main.py` exposes `/i18n/en.json`, etc.
  - The admin page route is `GET /admin/i18n` → serves `src/frontend/pages/admin-i18n.html`.

## Storage Model (DB/FS)
- **In this project** the i18n data is stored as JSON files on disk in the `i18n/` directory:
  - `read_locale(lang)` and `write_locale(lang, data)` encapsulate file IO.
  - Example: `i18n/en.json`, `i18n/de.json`.
- **DB-first option (reference)**
  - For a normalized Postgres schema, see `docs/bootstrap/ui_translate.md` (tables `i18n_locales`, `i18n_keys`, `i18n_entries`, etc.). This repo currently uses the simpler JSON-files approach.

## Frontend Runtime Wiring
- Files: `src/frontend/js/i18n-runtime.js`, `src/frontend/js/i18n-ui.js`.
- `i18n-runtime.js`
  - `initI18n()` bootstraps on page load (via `data-i18n-init`).
  - `setLanguage(lang)` fetches `/i18n/${lang}.json` and `/i18n/en.json` and updates DOM nodes marked with `data-i18n*` attributes.
  - Provides `t(key, params)` for string access and interpolation.
- `i18n-ui.js`
  - Optional helper for a language selector; persists preference in `localStorage` and calls `setLanguage()`.
- Admin page JS (`<script type="module">` in `admin-i18n.html`)
  - Loads keys: `GET /i18n-admin/keys?lang=XX`.
  - Save key: `PATCH /i18n-admin/keys?lang=XX&key=K&value=V`.
  - Import missing: `POST /i18n-admin/import-missing?lang=XX`.
  - Per-key AI translate: `POST /i18n-admin/translate-key` with `{ lang, key }`.
  - Batch translate: computes candidate keys by diffing EN vs target, then loops per-key translate with progress/cancel and optional debug logging.
  - Debug: checkbox toggles panel; SSE `/notify/events` also appends `i18n_debug` entries.

## End-to-End Flow
- **Per-key translate**
  1) User clicks `Translate` next to a row in `#table`.
  2) Frontend POSTs `{ lang, key }` → `/i18n-admin/translate-key` with auth + CSRF.
  3) Backend reads EN source, masks placeholders, calls `translate_text()` from `..services.ai_service` with `return_prompt=True`.
  4) On response, unmasks placeholders, retries if identical to EN, trims trailing punctuation if needed, writes to `i18n/XX.json`.
  5) Frontend updates the input, flashes green, and emits a toast. If debug is enabled, logs `{ key, src, dst, prompt }`.

- **Batch translate**
  1) Frontend loads EN and target maps.
  2) Candidates are keys missing in target or equal to EN.
  3) Iterates, calling `/translate-key` per candidate with small delay; supports cancel button.
  4) Progress is displayed via `<progress>` and status span; debug logs collect prompts via SSE or per-call results.

- **Import missing**
  - Copies all EN keys absent in target into the target file without AI.

## Replication Guide (reuse in another Windsurf project)
- **Prereqs**
  - FastAPI app with auth middleware and role checks similar to `require_role()`.
  - An AI translate function `translate_text(text, target_lang, ...)` available in your services layer.

- **Steps**
  1) Copy frontend runtime files and page
     - `src/frontend/js/i18n-runtime.js`
     - `src/frontend/js/i18n-ui.js` (optional, for language switchers)
     - `src/frontend/pages/admin-i18n.html`
  2) Mount static locales and page routes
     - `app.mount("/i18n", StaticFiles(directory="i18n"))`
     - Add a route `GET /admin/i18n` to serve your copied `admin-i18n.html`.
  3) Copy backend router
     - `src/backend/app/api/i18n_admin.py` and include it: `app.include_router(i18n_admin_router)`.
     - Ensure your `require_role` and `csrf_validate` dependencies exist or adapt the imports.
     - Provide `..services.ai_service.translate_text` with a compatible signature; return `{ "output": str, "prompt": str }` when `return_prompt=True`.
  4) Create locale directory and seed EN
     - Make `i18n/` and add `i18n/en.json` (see current repo for an example set of keys).
  5) Verify endpoints
     - `GET /i18n-admin/locales` should list `[{ code: "en" }]`.
     - `GET /i18n/en.json` should serve the JSON file.
  6) Test UI
     - Open `/admin/i18n`, select a target language, click `Import Missing`, then try `Batch Translate`.
  7) Optional: wire SSE debug
     - If you have a notify stream, emit events of type `i18n_debug` with `{ key, src, dst, prompt }` to surface prompts in the panel.

- **Security notes**
  - Keep admin endpoints behind auth; allow roles `admin` and `moderator` only.
  - Require a CSRF token for mutations.
  - Consider rate limiting AI calls server-side.

## File Map (reference)
- **Frontend**
  - `src/frontend/pages/admin-i18n.html`
  - `src/frontend/js/i18n-runtime.js`
  - `src/frontend/js/i18n-ui.js`
- **Backend**
  - `src/backend/app/api/i18n_admin.py`
  - `src/backend/app/main.py` (router include + `app.mount('/i18n', ...)`)
- **Locales**
  - `i18n/en.json` (source)
  - `i18n/*.json` (targets)
